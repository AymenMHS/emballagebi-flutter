<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../style-index.css">
  <title>EmballageBI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
    rel="stylesheet">
  <script src="../runtime_config.js"></script>

  <script>
    // force explicit API_BASE (tu as déjà ça)
    window.API_BASE = "https://emballage-b-impression.dz/emballage_bi";
    // Sauvegarde immédiate de la vraie fetch native AVANT que d'autres scripts puissent l'écraser
    if (!window.__API_NATIVE_FETCH_BACKUP) {
      try {
        window.__API_NATIVE_FETCH_BACKUP = window.fetch.bind(window);
        console.log('runtime_config forced:', window.API_BASE, ' — native fetch backed up.');
      } catch (e) {
        console.warn('Impossible de binder fetch native:', e);
      }
    }
  </script>

  <!-- api wrapper depends on window.API_BASE -->
  <script src="../api.js"></script>
  <!-- verify-connected uses api/buildApiUrl & binds logout -->
  <script src="../verify-connected.js"></script>
  <script src="../notification.js"></script>
  <script src="../ui-shell.js"></script>
  <link rel="stylesheet" href="../notif.css">
  <link rel="stylesheet" href="../responsive.css">
</head>
<style>
  .index-start {
    background: linear-gradient(180deg, rgb(208, 160, 160) 0%, rgb(136, 102, 102) 100%);
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .index-container {
    animation: fadeInUp;
    animation-duration: 1s;
  }

  .modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }

  .modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(1px);
  }

  .modal-panel {
    position: relative;
    z-index: 10001;
    background: #fff;
    width: 380px;
    max-width: 90%;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, .2);
    padding: 18px;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .modal-header h2 {
    margin: 0;
    font-size: 1.1rem;
  }

  .modal-close {
    background: transparent;
    border: none;
    font-size: 1.6rem;
    cursor: pointer;
  }

  .modal-body {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .modal-body label {
    font-size: 0.9rem;
  }

  .modal-body input[type="text"] {
    padding: 8px 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 1rem;
  }

  .form-row {
    display: flex;
    gap: 8px;
    margin-top: 6px;
  }

  #submitAddCategory {
    padding: 8px 12px;
    border-radius: 6px;
    border: none;
    background: #2077ff;
    color: white;
    cursor: pointer;
  }

  .btn-secondary {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: transparent;
    cursor: pointer;
  }

  .msg {
    color: #d00;
    font-size: 0.9rem;
    margin-top: 6px;
    min-height: 1.2em;
  }


  .index-start .logo {
    width: 30% !important;
  }

  .index-start .logo img {
    width: 60px !important;
    height: 60px !important;
    display: block;
    transition: transform 0.25s ease;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    /* propre sur mobile */
  }

  .index-start .logo img:hover,
  .index-start .logo img:focus {
    transform: scale(1.05);
    /* Agrandit de 5% */
  }

  .index-start .logo img:active {
    transform: scale(1.00);
  }

  .index-start .logo .title-logo h1 {
    font-size: 30px !important;
    width: 300px !important;
    top: 10px !important;
  }

  .index-start .logo .title-logo p {
    font-size: 18px !important;
    color: rgb(255, 36, 36);
    margin: 0;
    padding: 0;
    position: absolute;
    bottom: -3px !important;
    right: -40px !important;
    font-weight: 600;
  }

  .returnBtn img {
    width: 30px;
    height: 30px;
    filter: invert(1);
  }

  .returnBtn img:hover {
    opacity: 0.5;
    cursor: pointer;
    transition: 0.3s ease;
  }

  /* Sidebar & sidenotif mobile-friendly */
  .sidebar,
  .sidenotif {
    position: fixed;
    top: 0;
    height: 100vh;
    z-index: 10001;
    will-change: transform;
    touch-action: pan-y;
    /* on permet le scroll vertical, on gère horizontal manuellement */
    -webkit-overflow-scrolling: touch;
  }

  /* largeur par défaut (desktop) */
  .sidebar {
    left: 0;
    width: 280px;
    transform: translateX(-100%);
    transition: transform 280ms ease;
  }

  .sidenotif {
    right: 0;
    width: 360px;
    transform: translateX(100%);
    transition: transform 280ms ease;
  }

  /* overlay (déjà .filterblack dans ton HTML, on s'assure du style) */
  .filterblack {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    display: none;
    opacity: 0;
    transition: opacity 220ms ease;
    -webkit-tap-highlight-color: transparent;
  }

  /* état ouvert (JS ajoute/retire ces classes) */
  .sidebar.open {
    transform: translateX(0) !important;
  }

  .sidenotif.open {
    transform: translateX(0) !important;
  }

  .filterblack.visible {
    display: block;
    opacity: 0.8;
  }

  /* Ajustements responsive : faire icônes visibles sur téléphone si besoin */
  @media (max-width: 900px) {
    .sidebar {
      width: 78vw;
      max-width: 360px;
    }

    .sidenotif {
      width: 86vw;
      max-width: 420px;
    }

    .header .burger img {
      width: 26px;
      height: 26px;
    }

    /* icône plus petite */
  }

  /* Interaction tactile pendant le drag : disable transition while dragging */
  .sidebar.dragging,
  .sidenotif.dragging {
    transition: none !important;
  }

  .body-all-product .filter-all-product #btnOpenCloseFilter {
    display: none !important;
  }
</style>

<body>
  <div class="filterblack"></div>
  <div class="sidenotif" data-user-id="">
    <div class="notif-header">
      <img src="../img/icon/notifications.png">
      <h2>Notifications</h2>
    </div>
    <div class="notif-elements" style="width: 360px !important;">
      <div class="notif-loading">
        <p>Chargement des notifications...</p>
      </div>
    </div>
  </div>
  <div class="sidebar">
    <img src="../img/icon/menu.png" alt="Close" class="close-sidebar">
    <div class="logo">
      <img src="../img/logoblanc.png" alt="EmballageBI">
      <div class="title-logo">
        <h1>Emballage BI</h1>
        <p>2026</p>
      </div>
    </div>
    <nav class="sidebar-nav">
      <ul>
        <li onclick="window.location.href = '../index.html'" onclick="window.location.href = '../index.html'"><a
            href="#"><img src="../img/icon/home.png" alt="Home"> Tableau de bord</a></li>
        <hr>
        <li onclick="window.location.href = '../Plaque/suiviplaque.html'"><a href="#"><img
              src="../img/icon/papeterie-papiers-empiles.png" alt="Plaques"> Suivi des Plaques</a></li>
        <li onclick="window.location.href = '../Plaque/plaques.html'"><a href="#"><img src="../img/icon/plaques.png"
              alt="Plaques"> Plaques</a></li>
        <hr>
        <li onclick="window.location.href = '../Client/clients.html'"><a href="#"><img src="../img/icon/client.png"
              alt="Client"> Clients</a></li>
        <li onclick="window.location.href = '../Produit/produits.html'"><a href="#"><img
              src="../img/icon/produit - Copie.png" alt="Produit"> Produits</a></li>
        <li onclick="window.location.href = '../Conception/conceptions.html'"><a href="#"><img
              src="../img/icon/personnalisation1.png" alt="Conception"> Conceptions</a></li>
        <hr>
        <li onclick="window.location.href = '../Scan/scan.html'"><a href="#"><img src="../img/icon/qrcode.png" alt="QR">
            Scan
            QR</a></li>
        <li onclick="window.location.href = '../Annonces/annonces.html'"><a href="#"><img src="../img/icon/annonce.png"
              alt="Annonces"> Annonces</a></li>
        <hr>
        <li onclick="window.location.href = '../User/profil.html'"><a href="#"><img src="../img/icon/user.png"
              alt="User">
            Profil</a></li>
        <li onclick="window.location.href = '../Parametres/parametres.html'"><a href="#"><img
              src="../img/icon/parametres.png" alt="Parametres"> Parametres</a></li>

      </ul>
      <a href="#" id="logoutBtn"><img src="../img/icon/se-deconnecter.png" alt="Parametres"> Se deconnecter</a>
    </nav>
  </div>

  <div class="index-start">
    <div class="header" style="justify-content: space-evenly;">
      <div class="user-space" style="display: flex;justify-content: flex-start;width: 15%;">
        <div class="burger" style="margin-left: 30px;">
          <img src="../img/icon/menu.png" alt="Menu">
        </div>
        <div class="returnBtn"
          style="margin-left: 40px;width: 40px;height: 40px;display: flex;justify-content: center;align-items: center;"
          onclick="window.location.href='../index.html'">
          <img src="../img/icon/retourner.png">
        </div>
      </div>
      <div class="logo" onclick="window.location.href='../index.html'">
        <img src="../img/logoblanc.png" alt="EmballageBI" data-red="../img/logorouge.png" tabindex="0" />
      </div>
      <div class="user-space" style="display: flex;justify-content: flex-end;width: 15%;">
        <div class="notif-user">
          <img src="../img/icon/notifications.png" alt="Notifications">
          <span class="notif-count">0</span>
        </div>
        <div class="user-info" onclick="window.location.href='../user/profil.html'">
          <img src="../img/icon/profil.png" alt="User">
        </div>
      </div>
    </div>
    <div class="index-container">
      <div class="linkpages">
        <a href="../index.html">Tableau de bord </a> > Produits
      </div>
      <div class="container-new-plaque" id="produit">
        <div class="header-all-product">
          <div class="input-search-product">
            <img src="../img/icon/recherche.png" alt="searchInput">
            <input id="searchInput" type="text" placeholder="Rechercher un produit...">
          </div>
          <button class="btn-add-plaque" onclick="window.location.href='newproduit.html'">
            <img src="../img/icon/addproduct.png" alt="addProduct">
            <p>Nouveau Produit</p>
          </button>
        </div>
        <div class="body-all-product">
          <div class="filter-all-product">
            <div id="btnOpenCloseFilter"
              style="width: 100%;height: 50px;display: flex;justify-content: flex-end;align-items: center;">
              <button type="button"
                style="width: 40px;height: 40px;margin-right: 10px;margin-left: 10px; border: none;background-color: black;border-radius: 10px;">
                <img src="../img/icon/menu.png" style="width: 20px;height: 20px;">
              </button>
            </div>
            <div class="bloc-filter-product">
              <span>
                <img src="../img/icon/produit - Copie.png" alt="product">
                Categories
              </span>
              <div class="select-arrow" style="display: flex;justify-content: center;align-items: center;">
                <select id="categorySelect" style="width: 70%;">
                  <option value="">--Selectionnez une Categorie--</option>

                </select>
                <button type="button" id="addCategory"
                  style="width: 30px;height: 30px;display: flex;justify-content: center;align-items: center;border: none;background-color: black;border-radius: 5px;cursor: pointer;margin-left: 5px;"><img
                    src="../img/icon/plus.png" style="width: 20px;height: 20px;filter: invert(1);"></button>
              </div>
            </div>
            <div class="bloc-filter-product">
              <span>
                <img src="../img/icon/emballage.png" alt="emballage">
                Emballages
              </span>
              <p>
                <input type="checkbox">
                Les plus demandés
              </p>
              <p>
                <input type="checkbox">
                Nouveautés
              </p>
            </div>
            <div class="bloc-filter-product">
              <span>
                <img src="../img/icon/categorie.png" alt="emballage">
                Types
              </span>
              <p>
                <input type="checkbox">
                Cartons Offset
              </p>
              <p>
                <input type="checkbox">
                Sacs
              </p>
              <p>
                <input type="checkbox">
                Papier
              </p>
              <p>
                <input type="checkbox">
                Ondulé
              </p>
            </div>
          </div>
          <div class="table-all-product">
            <div class="header-table-all-product">
              <div class="title-table">
                <h1>Tout les produits</h1>
                <p>255 produits</p>
              </div>
              <div class="triage-table">
                <span>Trier par :</span>
                <select id="sortSelect">
                  <option value="">--Selectionnez une option--</option>
                  <option value="min_quantity">Quantité minimum</option>
                  <option value="date_desc">Plus récent -> Plus ancien</option>
                  <option value="date_asc">Plus ancien -> Plus récent</option>
                </select>
              </div>
            </div>
            <div id="table-products">
              <div class="table">
                <div class="thead">
                  <div class="col col1">Produit</div>
                  <div class="col col2">Type</div>
                  <div class="col col3">Prix</div>
                  <div class="col col4">Date création</div>
                  <div class="col col5">Actions</div>
                </div>
                <div class="tbody">

                </div>
              </div>
            </div>
            <div class="pagination-products">
              <div class="pages-pagination">

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      // --- CONFIG ---
      const BREAKPOINT = 1200; // largeur en px
      const OVERLAY_ID = 'filterModalOverlay';
      const MOBILE_BTN_ID = 'mobileFilterOpenBtn';
      // ----------------

      // Injecte styles nécessaires pour le modal (pour éviter d'éditer CSS)
      const css = `
      /* Overlay modal */
      #${OVERLAY_ID} {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.45);
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 18px;
      }
      #${OVERLAY_ID}.active { display: flex; }
      /* Wrapper contenant le filtre (limiter taille et scroll) */
      #${OVERLAY_ID} .filter-modal-wrapper {
        width: 100%;
        max-width: 420px;
        max-height: 92vh;
        overflow-y: auto;
        background: #fff;
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 12px 36px rgba(0,0,0,0.18);
      }
      /* S'assurer que .filter-all-product s'affiche bien dans le modal */
      #${OVERLAY_ID} .filter-modal-wrapper .filter-all-product {
        display: block !important;
        width: 100% !important;
        margin: 0 !important;
        box-shadow: none !important;
      }
      /* Bouton mobile flottant */
      #${MOBILE_BTN_ID} {
        position: fixed;
        right: 18px;
        bottom: 18px;
        z-index: 2100;
        width: 52px;
        height: 52px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.85);
        color: #fff;
        border: none;
        cursor: pointer;
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      }
      #${MOBILE_BTN_ID} img { width: 22px; height: 22px; filter: invert(0); }
      /* (optionnel) cacher le container d'origine si tu veux réserver l'espace : 
        on ne l'utilise pas ici car on déplace l'élément plutôt que de le cloner */
      .filter-mobile-placeholder { display: none; }

      .filter-all-product {
        width: calc(20% - 10px);
        height: calc(100% - 10px);
        background-color: #c7c6c6;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        border-radius: 10px;
        margin: 5px;
      }

      .filter-all-product .bloc-filter-product {
        width: 100%;
        height: auto;
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin-top: 10px;
      }

      .filter-all-product .bloc-filter-product span {
        width: 100%;
        height: 30px;
        font-size: 18px;
        justify-content: center;
        align-items: center;
        font-family: "Nunito", sans-serif;
        font-weight: bold;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        margin-left: 10px;
      }

      .filter-all-product .bloc-filter-product span img {
        width: 20px;
        height: 20px;
        margin-right: 10px;
      }

      .filter-all-product .bloc-filter-product select {
        width: 90%;
        height: 30px;
        margin-left: 10px;
        border: none;
        border-radius: 5px;
        margin-bottom: 10px;
        margin-top: 10px;
      }

      .filter-all-product .bloc-filter-product p {
        width: 80%;
        height: 30px;
        font-family: "Nunito", sans-serif;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        margin: 0;
        padding: 0;
        margin-left: 20px;
      }

      .filter-all-product .bloc-filter-product p input {
        width: 15px;
        height: 15px;
        margin-right: 5px;
      }
      `;
      const style = document.createElement('style');
      style.setAttribute('data-generated', 'filter-modal-js');
      style.appendChild(document.createTextNode(css));
      document.head.appendChild(style);

      // Références DOM
      const filterSelector = '.body-all-product .filter-all-product';
      let filterEl = document.querySelector(filterSelector);
      if (!filterEl) {
        console.warn('filter-all-product introuvable — script annulé');
        return;
      }

      // Crée overlay (mais ne l'ajoute pas encore au DOM)
      let overlay = document.createElement('div');
      overlay.id = OVERLAY_ID;
      overlay.setAttribute('aria-hidden', 'true');
      overlay.innerHTML = '<div class="filter-modal-wrapper" role="dialog" aria-modal="true"></div>';

      // Placeholder comment pour restaurer à la bonne place
      let placeholder = null;

      // bouton mobile (clone du bouton intérieur si existe, sinon icone simple)
      let mobileBtn = null;

      // Debounce de resize
      let resizeTimer = null;

      function createMobileButton() {
        if (document.getElementById(MOBILE_BTN_ID)) return document.getElementById(MOBILE_BTN_ID);
        const btn = document.createElement('button');
        btn.id = MOBILE_BTN_ID;
        btn.type = 'button';
        // essaie de cloner l'img du bouton original si présent
        const innerBtnImg = filterEl.querySelector('#btnOpenCloseFilter img');
        if (innerBtnImg) {
          const img = innerBtnImg.cloneNode(true);
          btn.appendChild(img);
        } else {
          btn.textContent = 'Filtres';
        }
        document.body.appendChild(btn);
        // accessibilité
        btn.setAttribute('aria-label', 'Ouvrir les filtres');
        return btn;
      }

      function openModal() {
        if (!overlay) return;
        // insert overlay into DOM if not present
        if (!document.body.contains(overlay)) {
          document.body.appendChild(overlay);
        }

        // create placeholder if not exists
        if (!placeholder) {
          // on utilise un commentaire placeholder pour restore exact
          placeholder = document.createComment('filter-placeholder');
        }

        // Si filterEl est encore dans le DOM et pas déjà dans la modal, on le déplace
        const wrapper = overlay.querySelector('.filter-modal-wrapper');
        if (filterEl.parentNode && filterEl.parentNode !== wrapper) {
          filterEl.parentNode.insertBefore(placeholder, filterEl); // on place le placeholder
          // IMPORTANT : **NE PAS** ajouter une classe "display:none" sur filterEl ici — on le déplace
          wrapper.appendChild(filterEl); // move the real node into the modal wrapper
        }

        overlay.classList.add('active');
        overlay.setAttribute('aria-hidden', 'false');

        // focus premier élément focusable
        setTimeout(() => {
          const focusable = wrapper.querySelector('input, button, select, [tabindex]:not([tabindex="-1"])');
          if (focusable) focusable.focus();
        }, 60);

        // add escape listener
        document.addEventListener('keydown', onKeyDown);
      }

      function closeModal() {
        if (!overlay) return;
        overlay.classList.remove('active');
        overlay.setAttribute('aria-hidden', 'true');

        // restore filterEl to its original place if placeholder exists
        if (placeholder && filterEl) {
          if (placeholder.parentNode) {
            placeholder.parentNode.insertBefore(filterEl, placeholder);
            placeholder.parentNode.removeChild(placeholder);
          }
          placeholder = null;
        }

        // remove overlay from DOM (clean)
        if (overlay.parentNode) overlay.parentNode.removeChild(overlay);

        // remove escape listener
        document.removeEventListener('keydown', onKeyDown);
      }

      function onOverlayClick(e) {
        // click sur overlay background (pas sur la wrapper) ferme
        if (e.target && e.target.id === OVERLAY_ID) {
          closeModal();
        }
      }

      function onKeyDown(e) {
        if (e.key === 'Escape') {
          closeModal();
        }
      }

      function enableMobileBehaviour() {
        // create mobile button if needed and show it
        mobileBtn = createMobileButton();
        mobileBtn.style.display = 'flex';
        // attach listeners
        mobileBtn.addEventListener('click', mobileBtnHandler);
        // click outside overlay to close
        overlay.addEventListener('click', onOverlayClick);
      }

      function disableMobileBehaviour() {
        // close modal if open
        closeModal();
        if (mobileBtn) {
          mobileBtn.removeEventListener('click', mobileBtnHandler);
          if (mobileBtn.parentNode) mobileBtn.parentNode.removeChild(mobileBtn);
          mobileBtn = null;
        }
        // cleanup overlay listeners
        overlay.removeEventListener('click', onOverlayClick);
        document.removeEventListener('keydown', onKeyDown);
      }

      function mobileBtnHandler(e) {
        // Toggle: if overlay active -> close, else open
        if (overlay.classList.contains('active')) {
          closeModal();
        } else {
          openModal();
        }
      }

      // Monitor resize to enable/disable behaviour
      function onResize() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          const w = window.innerWidth;
          if (w < BREAKPOINT) {
            if (!document.getElementById(MOBILE_BTN_ID)) enableMobileBehaviour();
          } else {
            disableMobileBehaviour();
          }
        }, 120);
      }

      // Initial setup on DOMContentLoaded
      function init() {
        if (window.innerWidth < BREAKPOINT) {
          enableMobileBehaviour();
        }
        window.addEventListener('resize', onResize);
      }

      // start when DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

      // Intercepter aussi le clic sur ton #btnOpenCloseFilter interne pour téléporter l'ouverture
      document.addEventListener('click', function (e) {
        const targetBtnContainer = document.querySelector('#btnOpenCloseFilter');
        if (!targetBtnContainer) return;
        if (targetBtnContainer.contains(e.target) && window.innerWidth < BREAKPOINT) {
          e.preventDefault();
          if (overlay.classList.contains('active')) closeModal(); else openModal();
        }
      });

    })();
  </script>


  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.index-start .logo img').forEach(img => {
        const whiteSrc = img.getAttribute('src');
        const redSrc = img.dataset.red;
        if (!redSrc) return; // si pas de data-red, on ignore

        // Précharger l'image rouge
        const preload = new Image();
        preload.src = redSrc;

        // Fonctions de swap
        const showRed = () => { img.src = redSrc; };
        const showWhite = () => { img.src = whiteSrc; };

        // Mouse / pointer
        img.addEventListener('mouseenter', showRed);
        img.addEventListener('mouseleave', showWhite);

        // Focus/blur pour accessibilité (clavier)
        img.addEventListener('focus', showRed);
        img.addEventListener('blur', showWhite);

        // Touch (mobile) — on utilise pointer events si dispo
        img.addEventListener('pointerdown', showRed);
        img.addEventListener('pointerup', showWhite);
        img.addEventListener('pointercancel', showWhite);

        // Fallback pour anciens navigateurs (touch)
        img.addEventListener('touchstart', showRed, { passive: true });
        img.addEventListener('touchend', showWhite, { passive: true });
      });
    });
  </script>
  <script>
    (async () => {
      const GET_TRIED = ['/api/categorie', '/api/categorie/list'];
      const POST_TRIED = ['/api/categorie', '/api/categorie/create'];

      const select = document.getElementById('categorySelect');
      const openBtn = document.getElementById('addCategory');

      // --- safe JSON helper
      async function safeJson(res) {
        try { return await res.json(); } catch (e) { return null; }
      }

      // --- populate select with items [{id_categorie, nom_categorie}, ...]
      function populateCategorySelect(items = []) {
        if (!select) return;
        const placeholderText = (select.options[0] && select.options[0].text) ? select.options[0].text : '--Selectionnez une Categorie--';
        select.innerHTML = '';
        const p = document.createElement('option');
        p.value = '';
        p.text = placeholderText;
        select.appendChild(p);

        items.forEach(it => {
          if (!it) return;
          const id = it.id_categorie || it.id || null;
          const name = it.nom_categorie || it.nom || it.name || (id ? String(id) : null);
          if (!name) return;
          const opt = document.createElement('option');
          opt.value = id || name;   // prefer id if present; fallback to name
          opt.textContent = name;
          if (id) opt.dataset.id = id;
          select.appendChild(opt);
        });
      }

      // --- fetch categories from backend (try multiple endpoints)
      async function fetchCategories() {
        for (const url of GET_TRIED) {
          try {
            const res = await fetch(url, { credentials: 'same-origin' });
            if (!res.ok) continue;
            const body = await safeJson(res);
            if (!body) continue;
            // support {items: [...]} or direct array
            let arr = null;
            if (Array.isArray(body)) arr = body;
            else if (Array.isArray(body.items)) arr = body.items;
            else if (Array.isArray(body.data)) arr = body.data;
            if (!arr && typeof body === 'object') {
              // if object with keys -> try convert
              const tmp = [];
              for (const k in body) {
                if (!Object.prototype.hasOwnProperty.call(body, k)) continue;
                const v = body[k];
                if (typeof v === 'string') tmp.push({ id_categorie: k, nom_categorie: v });
                else if (v && v.nom_categorie) tmp.push(v);
              }
              if (tmp.length) arr = tmp;
            }
            if (!arr) continue;
            // normalize to expected shape
            const normalized = arr.map(x => {
              if (typeof x === 'string') return { id_categorie: null, nom_categorie: x };
              return x;
            });
            return normalized;
          } catch (e) {
            continue;
          }
        }
        return null;
      }

      // --- post new category (returns { status, body })
      async function postCategory(name) {
        const payload = { nom_categorie: name };
        for (const url of POST_TRIED) {
          try {
            const res = await fetch(url, {
              method: 'POST',
              credentials: 'same-origin',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const body = await safeJson(res);
            return { status: res.status, body };
          } catch (e) {
            continue;
          }
        }
        return { status: 0, body: null };
      }

      // --- refresh on load
      async function refreshCategories() {
        const list = await fetchCategories();
        if (Array.isArray(list) && list.length) {
          populateCategorySelect(list);
        } else {
          // fallback: keep static options already in the DOM (do nothing)
          console.warn('Impossible de charger catégories depuis le backend — fallback aux options statiques.');
        }
      }

      // expose for debug
      window._Categories = window._Categories || {};
      window._Categories.refresh = refreshCategories;
      await refreshCategories();

      // ------------ Modal handling (create category) -------------
      // find modal or create minimal if not present
      let modal = document.getElementById('modalAddCategory');
      if (!modal) {
        const modalHtml = `
      <div id="modalAddCategory" class="modal" aria-hidden="true" style="display:none;">
        <div class="modal-overlay" data-close></div>
        <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
          <header class="modal-header">
            <h2 id="modalTitle">Ajouter une catégorie</h2>
            <button class="modal-close" aria-label="Fermer" data-close>&times;</button>
          </header>
          <form id="formAddCategory" class="modal-body">
            <label for="newCategoryName">Nom de la catégorie</label>
            <input id="newCategoryName" name="nom_categorie" type="text" maxlength="100" required autocomplete="off" />
            <div class="form-row">
              <button type="submit" id="submitAddCategory">Enregistrer</button>
              <button type="button" class="btn-secondary" data-close>Annuler</button>
            </div>
            <p id="addCategoryMsg" class="msg" aria-live="polite"></p>
          </form>
        </div>
      </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        modal = document.getElementById('modalAddCategory');
      }

      const form = modal.querySelector('#formAddCategory');
      const input = modal.querySelector('#newCategoryName');
      const msg = modal.querySelector('#addCategoryMsg');
      const submitBtn = modal.querySelector('#submitAddCategory');
      const closeEls = modal.querySelectorAll('[data-close]');

      function openModal() {
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden', 'false');
        if (input) { input.value = ''; setTimeout(() => input.focus(), 80); }
        if (msg) { msg.textContent = ''; msg.style.color = '#d00'; }
        document.addEventListener('keydown', onKeyDown);
      }
      function closeModal() {
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
        document.removeEventListener('keydown', onKeyDown);
      }
      function onKeyDown(e) { if (e.key === 'Escape') closeModal(); }

      if (openBtn) openBtn.addEventListener('click', (ev) => { ev.preventDefault(); openModal(); });
      closeEls.forEach(el => el.addEventListener('click', closeModal));

      // submit new category
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!input) return;
        const name = input.value.trim();
        if (!name) { msg.style.color = '#d00'; msg.textContent = 'Le nom de la catégorie est requis.'; return; }
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enregistrement...';
        msg.textContent = '';
        try {
          const { status, body } = await postCategory(name);
          if (status === 201 || status === 200) {
            const created = body || {};
            const createdName = created.nom_categorie || created.name || name;
            const createdId = created.id_categorie || created.id || null;

            // add option if not exists (compare by text)
            const exists = Array.from(select.options).some(o => (o.text || '').trim().toLowerCase() === (createdName || '').trim().toLowerCase());
            if (!exists) {
              const opt = document.createElement('option');
              opt.value = createdId || createdName;
              opt.text = createdName;
              if (createdId) opt.dataset.id = createdId;
              select.appendChild(opt);
            } else {
              // if exists but has no data-id and we have id, set it
              if (createdId) {
                Array.from(select.options).forEach(o => {
                  if ((o.text || '').trim().toLowerCase() === (createdName || '').trim().toLowerCase()) {
                    if (!o.dataset.id) o.dataset.id = createdId;
                    if (!o.value || o.value === createdName) o.value = createdId;
                  }
                });
              }
            }

            // select the created option (prefer id)
            if (createdId) {
              select.value = createdId;
            } else {
              select.value = createdName;
            }

            msg.style.color = 'green';
            msg.textContent = 'Catégorie ajoutée.';
            setTimeout(() => closeModal(), 550);
          } else if (status === 409) {
            msg.style.color = '#d00';
            msg.textContent = 'Cette catégorie existe déjà.';
          } else if (status === 400 || status === 422) {
            const detail = (body && (body.detail || body.message)) ? (body.detail || body.message) : 'Nom invalide.';
            msg.style.color = '#d00';
            msg.textContent = detail;
          } else if (status === 0) {
            msg.style.color = '#d00';
            msg.textContent = 'Impossible de contacter le serveur.';
          } else {
            const txt = (body && (body.detail || body.message)) ? (body.detail || body.message) : `Erreur serveur (${status})`;
            msg.style.color = '#d00';
            msg.textContent = txt;
          }
        } catch (err) {
          console.error(err);
          msg.style.color = '#d00';
          msg.textContent = 'Erreur lors de la requête.';
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Enregistrer';
        }
      });

      // expose addOption helper
      window._Categories = window._Categories || {};
      window._Categories.addOption = (id, name) => {
        if (!select) return;
        const exists = Array.from(select.options).some(o => (o.text || '').trim().toLowerCase() === (name || '').trim().toLowerCase());
        if (!exists) {
          const opt = document.createElement('option');
          opt.value = id || name;
          opt.text = name;
          if (id) opt.dataset.id = id;
          select.appendChild(opt);
        }
      };

    })();
  </script>

  <script src="allproduct.js"></script>
  <script>
    // Swipe & drag support pour sidebar (gauche) et sidenotif (droite)
    (function () {
      const sidebar = document.querySelector('.sidebar');
      const sidenotifEl = document.querySelector('.sidenotif');
      const filterOverlay = document.querySelector('.filterblack');

      if (!sidebar || !sidenotifEl || !filterOverlay) return;

      let startX = 0, currentX = 0, touching = false;
      let draggingPanel = null; // 'left' or 'right' or null
      const EDGE_THRESHOLD = 28; // px depuis le bord pour initier swipe
      const OPEN_THRESHOLD_RATIO = 0.25; // proportion needed to open

      // helpers
      function showOverlay() { filterOverlay.classList.add('visible'); }
      function hideOverlayIfClosed() {
        if (!sidebar.classList.contains('open') && !sidenotifEl.classList.contains('open')) {
          filterOverlay.classList.remove('visible');
        }
      }

      function setTranslateX(el, x) {
        el.style.transform = `translateX(${x}px)`;
      }

      function resetPanelStyle(el, side) {
        el.style.transform = '';
        el.classList.remove('dragging');
      }

      // Start touch (could be edge swipe or drag on panel)
      function onTouchStart(e) {
        if (e.touches && e.touches.length === 1) {
          startX = e.touches[0].clientX;
          currentX = startX;
          touching = true;
          draggingPanel = null;

          // edge swipe from left -> open sidebar
          if (startX <= EDGE_THRESHOLD && !sidebar.classList.contains('open')) {
            draggingPanel = 'left';
            sidebar.classList.add('dragging');
            showOverlay();
          }
          // edge swipe from right -> open sidenotif
          else if (startX >= (window.innerWidth - EDGE_THRESHOLD) && !sidenotifEl.classList.contains('open')) {
            draggingPanel = 'right';
            sidenotifEl.classList.add('dragging');
            showOverlay();
          } else {
            // if user touches on an open panel, allow closing by dragging it
            const rectLeft = sidebar.getBoundingClientRect();
            const rectRight = sidenotifEl.getBoundingClientRect();
            if (sidebar.classList.contains('open') && startX <= rectLeft.right) { draggingPanel = 'left'; sidebar.classList.add('dragging'); }
            else if (sidenotifEl.classList.contains('open') && startX >= rectRight.left) { draggingPanel = 'right'; sidenotifEl.classList.add('dragging'); }
          }
        }
      }

      function onTouchMove(e) {
        if (!touching || !draggingPanel || !e.touches || e.touches.length !== 1) return;
        currentX = e.touches[0].clientX;
        const dx = currentX - startX;

        if (draggingPanel === 'left') {
          // When closed, panel moves from -width to -width + dx (but clamped)
          const w = sidebar.offsetWidth;
          let translate = -w + Math.max(0, dx); // dx positive pulls it in
          // If panel already open and dx negative, allow closing with negative dx
          if (sidebar.classList.contains('open')) {
            translate = Math.min(0, dx); // dx negative moves it left to hide
          }
          // clamp
          translate = Math.min(0, Math.max(-w, translate));
          setTranslateX(sidebar, translate);
        } else if (draggingPanel === 'right') {
          const w = sidenotifEl.offsetWidth;
          let translate = w + Math.min(0, dx); // when closed dx negative pulls it in
          if (sidenotifEl.classList.contains('open')) {
            translate = Math.max(0, dx); // dx positive moves it right to hide
          }
          // translateX should be between 0 (open) and w (hidden)
          translate = Math.max(0, Math.min(w, translate));
          // convert to CSS value: we want translateX(translate) but for right panel initial closed state is +w px -> we use translateX(translate)
          setTranslateX(sidenotifEl, translate + 'px'); // keep px as string
        }
      }

      function onTouchEnd() {
        if (!touching || !draggingPanel) { touching = false; draggingPanel = null; return; }
        const dx = currentX - startX;
        if (draggingPanel === 'left') {
          const w = sidebar.offsetWidth;
          const opened = (sidebar.classList.contains('open')) ? (dx > -w * (1 - OPEN_THRESHOLD_RATIO)) : (dx > w * OPEN_THRESHOLD_RATIO);
          if (opened) {
            sidebar.classList.add('open');
            sidebar.style.transform = ''; // let CSS class handle transform
          } else {
            sidebar.classList.remove('open');
            sidebar.style.transform = ''; // reset
            hideOverlayIfClosed();
          }
          sidebar.classList.remove('dragging');
        } else if (draggingPanel === 'right') {
          const w = sidenotifEl.offsetWidth;
          const opened = (sidenotifEl.classList.contains('open')) ? (dx < w * (1 - OPEN_THRESHOLD_RATIO)) : (dx < -w * OPEN_THRESHOLD_RATIO);
          if (opened) {
            sidenotifEl.classList.add('open');
            sidenotifEl.style.transform = '';
          } else {
            sidenotifEl.classList.remove('open');
            sidenotifEl.style.transform = '';
            hideOverlayIfClosed();
          }
          sidenotifEl.classList.remove('dragging');
        }
        touching = false;
        draggingPanel = null;
      }

      // Attach global touch events (for edge swipes)
      document.addEventListener('touchstart', onTouchStart, { passive: true });
      document.addEventListener('touchmove', onTouchMove, { passive: true });
      document.addEventListener('touchend', onTouchEnd, { passive: true });
      document.addEventListener('touchcancel', onTouchEnd, { passive: true });

      // existing click handlers (kept)
      const burgerBtn = document.querySelector('.header .burger');
      const closeBtn = document.querySelector('.sidebar .close-sidebar');
      const notifBtn = document.querySelector('.notif-user');

      function openSidebar() { sidebar.classList.add('open'); showOverlay(); }
      function closeSidebar() { sidebar.classList.remove('open'); hideOverlayIfClosed(); }
      function openNotif() { sidenotifEl.classList.add('open'); showOverlay(); }
      function closeNotif() { sidenotifEl.classList.remove('open'); hideOverlayIfClosed(); }

      if (burgerBtn) burgerBtn.addEventListener('click', (e) => { e.stopPropagation(); openSidebar(); });
      if (closeBtn) closeBtn.addEventListener('click', (e) => { e.stopPropagation(); closeSidebar(); });
      if (notifBtn) notifBtn.addEventListener('click', (e) => { e.stopPropagation(); if (sidenotifEl.classList.contains('open')) closeNotif(); else openNotif(); });

      // close if overlay tapped
      filterOverlay.addEventListener('click', () => { closeSidebar(); closeNotif(); });

      // close with Escape for accessibility
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') { closeSidebar(); closeNotif(); }
      });

      // When panels are opened programmatically, ensure overlay visible
      const observer = new MutationObserver(() => {
        if (sidebar.classList.contains('open') || sidenotifEl.classList.contains('open')) showOverlay();
        else hideOverlayIfClosed();
      });
      observer.observe(sidebar, { attributes: true, attributeFilter: ['class'] });
      observer.observe(sidenotifEl, { attributes: true, attributeFilter: ['class'] });
    })();

  </script>



  <div id="modalAddCategory" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-overlay" data-close></div>
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header class="modal-header">
        <h2 id="modalTitle">Ajouter une catégorie</h2>
        <button class="modal-close" aria-label="Fermer" data-close>&times;</button>
      </header>
      <form id="formAddCategory" class="modal-body">
        <label for="newCategoryName">Nom de la catégorie</label>
        <input id="newCategoryName" name="nom_categorie" type="text" maxlength="100" required autocomplete="off" />
        <div class="form-row">
          <button type="submit" id="submitAddCategory">Enregistrer</button>
          <button type="button" class="btn-secondary" data-close>Annuler</button>
        </div>
        <p id="addCategoryMsg" class="msg" aria-live="polite"></p>
      </form>
    </div>
  </div>

</body>

</html>