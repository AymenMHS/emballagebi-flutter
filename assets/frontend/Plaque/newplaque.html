<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../style-index.css">
  <title>EmballageBI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="../notif.css">
  <link rel="stylesheet" href="../responsive.css">
  <script src="../runtime_config.js"></script>
  <script>
    // force explicit API_BASE (tu as déjà ça)
    window.API_BASE = "https://emballage-b-impression.dz/emballage_bi";
    // Sauvegarde immédiate de la vraie fetch native AVANT que d'autres scripts puissent l'écraser
    if (!window.__API_NATIVE_FETCH_BACKUP) {
      try {
        window.__API_NATIVE_FETCH_BACKUP = window.fetch.bind(window);
        console.log('runtime_config forced:', window.API_BASE, ' — native fetch backed up.');
      } catch (e) {
        console.warn('Impossible de binder fetch native:', e);
      }
    }
  </script>
  <!-- api wrapper depends on window.API_BASE -->
  <script src="../api.js"></script>
  <!-- verify-connected uses api/buildApiUrl & binds logout -->
  <script src="../verify-connected.js"></script>
  <script src="../notification.js"></script>
  <script src="../ui-shell.js"></script>

</head>
<style>
  .index-start {
    background: #639ED4;
    background: linear-gradient(180deg, rgba(99, 158, 212, 1) 0%, rgba(47, 94, 138, 1) 100%);
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .index-container {
    animation: fadeInRight;
    animation-duration: 1s;
  }

  .right-info {
    overflow: hidden;
  }


  .index-start .logo {
    width: 30% !important;
  }

  .index-start .logo img {
    width: 60px !important;
    height: 60px !important;
    display: block;
    transition: transform 0.25s ease;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    /* propre sur mobile */
  }

  .index-start .logo img:hover,
  .index-start .logo img:focus {
    transform: scale(1.05);
    /* Agrandit de 5% */
  }

  .index-start .logo img:active {
    transform: scale(1.00);
  }

  .index-start .logo .title-logo h1 {
    font-size: 30px !important;
    width: 300px !important;
    top: 10px !important;
  }

  .index-start .logo .title-logo p {
    font-size: 18px !important;
    color: rgb(255, 36, 36);
    margin: 0;
    padding: 0;
    position: absolute;
    bottom: -3px !important;
    right: -40px !important;
    font-weight: 600;
  }

  .returnBtn img {
    width: 30px;
    height: 30px;
    filter: invert(1);
  }

  .returnBtn img:hover {
    opacity: 0.5;
    cursor: pointer;
    transition: 0.3s ease;
  }

  /* Sidebar & sidenotif mobile-friendly */
  .sidebar,
  .sidenotif {
    position: fixed;
    top: 0;
    height: 100vh;
    z-index: 10001;
    will-change: transform;
    touch-action: pan-y;
    /* on permet le scroll vertical, on gère horizontal manuellement */
    -webkit-overflow-scrolling: touch;
  }

  /* largeur par défaut (desktop) */
  .sidebar {
    left: 0;
    width: 280px;
    transform: translateX(-100%);
    transition: transform 280ms ease;
  }

  .sidenotif {
    right: 0;
    width: 360px;
    transform: translateX(100%);
    transition: transform 280ms ease;
  }

  /* overlay (déjà .filterblack dans ton HTML, on s'assure du style) */
  .filterblack {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    display: none;
    opacity: 0;
    transition: opacity 220ms ease;
    -webkit-tap-highlight-color: transparent;
  }

  /* état ouvert (JS ajoute/retire ces classes) */
  .sidebar.open {
    transform: translateX(0) !important;
  }

  .sidenotif.open {
    transform: translateX(0) !important;
  }

  .filterblack.visible {
    display: block;
    opacity: 0.8;
  }

  /* Ajustements responsive : faire icônes visibles sur téléphone si besoin */
  @media (max-width: 900px) {
    .sidebar {
      width: 78vw;
      max-width: 360px;
    }

    .sidenotif {
      width: 86vw;
      max-width: 420px;
    }

    .header .burger img {
      width: 26px;
      height: 26px;
    }

    /* icône plus petite */
  }

  /* Interaction tactile pendant le drag : disable transition while dragging */
  .sidebar.dragging,
  .sidenotif.dragging {
    transition: none !important;
  }

  .ecrit-num-plaque button {
    display: none !important;
  }

  .ecrit-num-plaque input {
    width: 200px !important;
  }
</style>

<body>

  <div class="filterblack"></div>
  <div class="sidenotif" data-user-id="">
    <div class="notif-header">
      <img src="../img/icon/notifications.png">
      <h2>Notifications</h2>
    </div>
    <div class="notif-elements" style="width: 360px !important;">
      <div class="notif-loading">
        <p>Chargement des notifications...</p>
      </div>
    </div>
  </div>
  <div class="sidebar">
    <img src="../img/icon/menu.png" alt="Close" class="close-sidebar">
    <div class="logo">
      <img src="../img/logoblanc.png" alt="EmballageBI">
      <div class="title-logo">
        <h1>Emballage BI</h1>
        <p>2026</p>
      </div>
    </div>
    <nav class="sidebar-nav">
      <ul>
        <li onclick="window.location.href = '../index.html'" onclick="window.location.href = '../index.html'"><a
            href="#"><img src="../img/icon/home.png" alt="Home"> Tableau de bord</a></li>
        <hr>
        <li onclick="window.location.href = '../Plaque/suiviplaque.html'"><a href="#"><img
              src="../img/icon/papeterie-papiers-empiles.png" alt="Plaques"> Suivi des Plaques</a></li>
        <li onclick="window.location.href = '../Plaque/plaques.html'"><a href="#"><img src="../img/icon/plaques.png"
              alt="Plaques"> Plaques</a></li>
        <hr>
        <li onclick="window.location.href = '../Client/clients.html'"><a href="#"><img src="../img/icon/client.png"
              alt="Client"> Clients</a></li>
        <li onclick="window.location.href = '../Produit/produits.html'"><a href="#"><img
              src="../img/icon/produit - Copie.png" alt="Produit"> Produits</a></li>
        <li onclick="window.location.href = '../Conception/conceptions.html'"><a href="#"><img
              src="../img/icon/personnalisation1.png" alt="Conception"> Conceptions</a></li>
        <hr>
        <li onclick="window.location.href = '../Scan/scan.html'"><a href="#"><img src="../img/icon/qrcode.png" alt="QR">
            Scan
            QR</a></li>
        <li onclick="window.location.href = '../Annonces/annonces.html'"><a href="#"><img src="../img/icon/annonce.png"
              alt="Annonces"> Annonces</a></li>
        <hr>
        <li onclick="window.location.href = '../User/profil.html'"><a href="#"><img src="../img/icon/user.png"
              alt="User">
            Profil</a></li>
        <li onclick="window.location.href = '../Parametres/parametres.html'"><a href="#"><img
              src="../img/icon/parametres.png" alt="Parametres"> Parametres</a></li>

      </ul>
      <a href="#" id="logoutBtn"><img src="../img/icon/se-deconnecter.png" alt="Parametres"> Se deconnecter</a>
    </nav>
  </div>

  <div class="add-product">
    <iframe src="../Produit/newproduit.html" style="width: 100%; height: 100%;"></iframe>
  </div>

  <div class="add-client">
    <iframe src="../Client/newclient.html" style="width: 100%; height: 100%;"></iframe>
  </div>

  <div class="add-conception">
    <iframe src="../Conception/newconception.html" style="width: 100%; height: 100%;"></iframe>
  </div>

  <div class="index-start">
    <div class="header" style="justify-content: space-evenly;">
      <div class="user-space" style="display: flex;justify-content: flex-start;width: 15%;">
        <div class="burger" style="margin-left: 30px;">
          <img src="../img/icon/menu.png" alt="Menu">
        </div>
        <div class="returnBtn"
          style="margin-left: 40px;width: 40px;height: 40px;display: flex;justify-content: center;align-items: center;"
          onclick="window.location.href='plaques.html'">
          <img src="../img/icon/retourner.png">
        </div>
      </div>
      <div class="logo" onclick="window.location.href='../index.html'">
        <img src="../img/logoblanc.png" alt="EmballageBI" data-red="../img/logorouge.png" tabindex="0" />
      </div>
      <div class="user-space" style="display: flex;justify-content: flex-end;width: 15%;">
        <div class="notif-user">
          <img src="../img/icon/notifications.png" alt="Notifications">
          <span class="notif-count">0</span>
        </div>
        <div class="user-info" onclick="window.location.href='../user/profil.html'">
          <img src="../img/icon/profil.png" alt="User">
        </div>
      </div>
    </div>
    <div class="index-container">
      <div class="linkpages">
        <a href="../index.html">Tableau de bord </a> > <a href="plaques.html">Plaques</a> > Nouvelle Plaque
      </div>
      <div class="container-new-plaque">
        <div class="logonewplaque">
          <div class="Container-logonewplaque">
            <img src="../img/icon/papeterie-papiers-empiles.png" alt="Logo Plaque">
            <h1>Nouvelle Plaque</h1>
          </div>
        </div>
        <div class="all-info-plaque-container">
          <div class="left-info">
            <div class="first-info">
              <div class="conception-plaque">
                <span>Conception :</span>
                <div class="choose-conception-plaque">
                  <div class="custom-select" id="conceptionSelect" tabindex="0" aria-haspopup="listbox">
                    <div class="select-toggle" id="selectToggle" role="button" aria-expanded="false">
                      <img src="../img/icon/papeterie-papiers-empiles.png" alt="mini" class="selected-thumb">
                      <span class="selected-label">--Sélectionnez une conception--</span>
                      <span class="caret">▾</span>
                    </div>

                    <div class="dropdown" id="selectDropdown" role="listbox" aria-hidden="true">
                      <input type="search" placeholder="Recherchez votre conception..." class="select-search"
                        id="selectSearch">

                      <div class="section">
                        <p class="section-title">Conceptions récentes :</p>
                        <div class="options" id="recentOptions">
                          <!-- options récentes (exemple) -->

                        </div>
                      </div>

                      <div class="section">
                        <p class="section-title">Toutes les conceptions :</p>
                        <div class="options" id="allOptions">
                          <!-- toutes les options -->

                          <!-- ajoute/enlève autant d'options que nécessaire -->
                        </div>
                      </div>
                    </div>
                  </div>

                  <button class="add-conception-btn" id="addConceptionBtn">
                    <img src="../img/icon/plus.png" alt="addConception">
                    <p>Ajouter une conception</p>
                  </button>
                </div>
              </div>
              <div class="clientproduit-plaque">
                <span>Client :</span>
                <div class="choose-client-plaque">
                  <button id="addClientNew">
                    <img src="../img/icon/addclient.png" alt="newClient">
                  </button>
                </div>
              </div>
              <div class="clientproduit-plaque">
                <span>Produit :</span>
                <div class="choose-client-plaque">
                  <button id="addProductNew">
                    <img src="../img/icon/addproduct.png" alt="newProduct">
                  </button>
                </div>
              </div>
            </div>
            <div class="second-info">
              <p style="color: rgb(0, 0, 0);"><img src="../img/icon/papeterie-papiers-empiles.png"
                  style="width: 20px; height: 20px;margin-right: 10px;">Plaque(s) :</p>
              <div class="plaque-added">
                <!-- Plaques Rajouter -->

              </div>
            </div>
          </div>
          <div class="right-info">
            <div class="num-plaque">
              <span>N° de la plaque</span>
              <div class="ecrit-num-plaque">
                <input type="number">
                <button>
                  <img src="../img/icon/ocr.png" onclick="window.location.href='scan.html'">
                </button>
              </div>
            </div>
            <div class="container-couleur-pose-plaque">
              <div class="couleur-pose-plaque">
                <span>Couleur :</span>
                <input type="color">
              </div>
            </div>
            <div class="machine-add-plaque">
              <div class="machine-plaque">
                <span>Machine :</span>
                <select class="machine-select">
                  <option value="">--Selectionnez une machine--</option>
                  <option value="Kors">Kors</option>
                  <option value="Kord">Kord</option>
                  <option value="MOZ">MOZ</option>
                </select>
              </div>
              <div class="machine-plaque">
                <span>Statut :</span>
                <select class="statut-select">
                  <option value="en_stock">En stock</option>
                  <option value="en_impression">En impression</option>
                  <option value="en_sous_traitance">En sous-traitance</option>
                  <option value="en_quarantaine">En quarantaine</option>
                  <option value="indisponible">Indisponible</option>
                  <option value="comandees">Commandées</option>
                </select>

              </div>
            </div>
            <div class="btnadd-plaque">
              <button type="button">
                <img src="../img/icon/addfleche.png" alt="addPlaque">
                Ajouter la plaque
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.index-start .logo img').forEach(img => {
        const whiteSrc = img.getAttribute('src');
        const redSrc = img.dataset.red;
        if (!redSrc) return; // si pas de data-red, on ignore

        // Précharger l'image rouge
        const preload = new Image();
        preload.src = redSrc;

        // Fonctions de swap
        const showRed = () => { img.src = redSrc; };
        const showWhite = () => { img.src = whiteSrc; };

        // Mouse / pointer
        img.addEventListener('mouseenter', showRed);
        img.addEventListener('mouseleave', showWhite);

        // Focus/blur pour accessibilité (clavier)
        img.addEventListener('focus', showRed);
        img.addEventListener('blur', showWhite);

        // Touch (mobile) — on utilise pointer events si dispo
        img.addEventListener('pointerdown', showRed);
        img.addEventListener('pointerup', showWhite);
        img.addEventListener('pointercancel', showWhite);

        // Fallback pour anciens navigateurs (touch)
        img.addEventListener('touchstart', showRed, { passive: true });
        img.addEventListener('touchend', showWhite, { passive: true });
      });
    });
  </script>
  <script>
    // Swipe & drag support pour sidebar (gauche) et sidenotif (droite)
    (function () {
      const sidebar = document.querySelector('.sidebar');
      const sidenotifEl = document.querySelector('.sidenotif');
      const filterOverlay = document.querySelector('.filterblack');

      if (!sidebar || !sidenotifEl || !filterOverlay) return;

      let startX = 0, currentX = 0, touching = false;
      let draggingPanel = null; // 'left' or 'right' or null
      const EDGE_THRESHOLD = 28; // px depuis le bord pour initier swipe
      const OPEN_THRESHOLD_RATIO = 0.25; // proportion needed to open

      // helpers
      function showOverlay() { filterOverlay.classList.add('visible'); }
      function hideOverlayIfClosed() {
        if (!sidebar.classList.contains('open') && !sidenotifEl.classList.contains('open')) {
          filterOverlay.classList.remove('visible');
        }
      }

      function setTranslateX(el, x) {
        el.style.transform = `translateX(${x}px)`;
      }

      function resetPanelStyle(el, side) {
        el.style.transform = '';
        el.classList.remove('dragging');
      }

      // Start touch (could be edge swipe or drag on panel)
      function onTouchStart(e) {
        if (e.touches && e.touches.length === 1) {
          startX = e.touches[0].clientX;
          currentX = startX;
          touching = true;
          draggingPanel = null;

          // edge swipe from left -> open sidebar
          if (startX <= EDGE_THRESHOLD && !sidebar.classList.contains('open')) {
            draggingPanel = 'left';
            sidebar.classList.add('dragging');
            showOverlay();
          }
          // edge swipe from right -> open sidenotif
          else if (startX >= (window.innerWidth - EDGE_THRESHOLD) && !sidenotifEl.classList.contains('open')) {
            draggingPanel = 'right';
            sidenotifEl.classList.add('dragging');
            showOverlay();
          } else {
            // if user touches on an open panel, allow closing by dragging it
            const rectLeft = sidebar.getBoundingClientRect();
            const rectRight = sidenotifEl.getBoundingClientRect();
            if (sidebar.classList.contains('open') && startX <= rectLeft.right) { draggingPanel = 'left'; sidebar.classList.add('dragging'); }
            else if (sidenotifEl.classList.contains('open') && startX >= rectRight.left) { draggingPanel = 'right'; sidenotifEl.classList.add('dragging'); }
          }
        }
      }

      function onTouchMove(e) {
        if (!touching || !draggingPanel || !e.touches || e.touches.length !== 1) return;
        currentX = e.touches[0].clientX;
        const dx = currentX - startX;

        if (draggingPanel === 'left') {
          // When closed, panel moves from -width to -width + dx (but clamped)
          const w = sidebar.offsetWidth;
          let translate = -w + Math.max(0, dx); // dx positive pulls it in
          // If panel already open and dx negative, allow closing with negative dx
          if (sidebar.classList.contains('open')) {
            translate = Math.min(0, dx); // dx negative moves it left to hide
          }
          // clamp
          translate = Math.min(0, Math.max(-w, translate));
          setTranslateX(sidebar, translate);
        } else if (draggingPanel === 'right') {
          const w = sidenotifEl.offsetWidth;
          let translate = w + Math.min(0, dx); // when closed dx negative pulls it in
          if (sidenotifEl.classList.contains('open')) {
            translate = Math.max(0, dx); // dx positive moves it right to hide
          }
          // translateX should be between 0 (open) and w (hidden)
          translate = Math.max(0, Math.min(w, translate));
          // convert to CSS value: we want translateX(translate) but for right panel initial closed state is +w px -> we use translateX(translate)
          setTranslateX(sidenotifEl, translate + 'px'); // keep px as string
        }
      }

      function onTouchEnd() {
        if (!touching || !draggingPanel) { touching = false; draggingPanel = null; return; }
        const dx = currentX - startX;
        if (draggingPanel === 'left') {
          const w = sidebar.offsetWidth;
          const opened = (sidebar.classList.contains('open')) ? (dx > -w * (1 - OPEN_THRESHOLD_RATIO)) : (dx > w * OPEN_THRESHOLD_RATIO);
          if (opened) {
            sidebar.classList.add('open');
            sidebar.style.transform = ''; // let CSS class handle transform
          } else {
            sidebar.classList.remove('open');
            sidebar.style.transform = ''; // reset
            hideOverlayIfClosed();
          }
          sidebar.classList.remove('dragging');
        } else if (draggingPanel === 'right') {
          const w = sidenotifEl.offsetWidth;
          const opened = (sidenotifEl.classList.contains('open')) ? (dx < w * (1 - OPEN_THRESHOLD_RATIO)) : (dx < -w * OPEN_THRESHOLD_RATIO);
          if (opened) {
            sidenotifEl.classList.add('open');
            sidenotifEl.style.transform = '';
          } else {
            sidenotifEl.classList.remove('open');
            sidenotifEl.style.transform = '';
            hideOverlayIfClosed();
          }
          sidenotifEl.classList.remove('dragging');
        }
        touching = false;
        draggingPanel = null;
      }

      // Attach global touch events (for edge swipes)
      document.addEventListener('touchstart', onTouchStart, { passive: true });
      document.addEventListener('touchmove', onTouchMove, { passive: true });
      document.addEventListener('touchend', onTouchEnd, { passive: true });
      document.addEventListener('touchcancel', onTouchEnd, { passive: true });

      // existing click handlers (kept)
      const burgerBtn = document.querySelector('.header .burger');
      const closeBtn = document.querySelector('.sidebar .close-sidebar');
      const notifBtn = document.querySelector('.notif-user');

      function openSidebar() { sidebar.classList.add('open'); showOverlay(); }
      function closeSidebar() { sidebar.classList.remove('open'); hideOverlayIfClosed(); }
      function openNotif() { sidenotifEl.classList.add('open'); showOverlay(); }
      function closeNotif() { sidenotifEl.classList.remove('open'); hideOverlayIfClosed(); }

      if (burgerBtn) burgerBtn.addEventListener('click', (e) => { e.stopPropagation(); openSidebar(); });
      if (closeBtn) closeBtn.addEventListener('click', (e) => { e.stopPropagation(); closeSidebar(); });
      if (notifBtn) notifBtn.addEventListener('click', (e) => { e.stopPropagation(); if (sidenotifEl.classList.contains('open')) closeNotif(); else openNotif(); });

      // close if overlay tapped
      filterOverlay.addEventListener('click', () => { closeSidebar(); closeNotif(); });

      // close with Escape for accessibility
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') { closeSidebar(); closeNotif(); }
      });

      // When panels are opened programmatically, ensure overlay visible
      const observer = new MutationObserver(() => {
        if (sidebar.classList.contains('open') || sidenotifEl.classList.contains('open')) showOverlay();
        else hideOverlayIfClosed();
      });
      observer.observe(sidebar, { attributes: true, attributeFilter: ['class'] });
      observer.observe(sidenotifEl, { attributes: true, attributeFilter: ['class'] });
    })();

  </script>


  <!-- Notification script -->
  <script>
    (() => {
      // Récupère un token CSRF si le backend le fournis (meta tag ou cookie "XSRF-TOKEN")
      function getCsrfToken() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        if (meta) return meta.getAttribute('content') || null;
        const name = 'XSRF-TOKEN=';
        const cookie = document.cookie.split('; ').find(c => c.startsWith(name));
        if (cookie) return decodeURIComponent(cookie.substring(name.length));
        return null;
      }

      // sanitize simple pour affichage (retire contrôles non imprimables et <, > pour réduire risque d'injection)
      function safeText(v) {
        if (v === null || v === undefined) return '';
        return String(v).replace(/[\u0000-\u001F\u007F<>]/g, '').trim();
      }

      // wrapper fetch qui ajoute CSRF header s'il existe
      async function fetchWithCsrf(url, opts = {}) {
        opts.credentials = 'include';
        opts.headers = opts.headers || {};
        const token = getCsrfToken();
        if (token) opts.headers['X-CSRF-Token'] = token;
        // Accept default json in many endpoints
        opts.headers['Accept'] = opts.headers['Accept'] || 'application/json';
        return fetch(url, opts);
      }

      document.addEventListener('DOMContentLoaded', () => {
        /* ------------------ Overlay & boutons d'action ------------------ */
        const ROOT_SELECTOR = '.index-start .index-elements';
        const AREA = document.querySelector(ROOT_SELECTOR);
        if (AREA) {
          const buttons = Array.from(AREA.querySelectorAll('button'));
          if (buttons.length) {
            const ANIM_DURATION = 650;
            const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            let overlay = null;
            function ensureOverlay() {
              if (overlay) return overlay;
              overlay = document.createElement('div');
              overlay.className = 'plaques-bg-overlay';
              // apparence neutre sécurisée par défaut
              overlay.style.position = 'fixed';
              overlay.style.inset = '0';
              overlay.style.zIndex = '9998';
              overlay.style.pointerEvents = 'auto';
              overlay.style.transition = 'opacity 0.25s ease';
              overlay.style.backgroundColor = 'rgba(0,0,0,0.85)';
              document.body.appendChild(overlay);
              return overlay;
            }

            function pickBackgroundFromElement(el) {
              try {
                const cs = getComputedStyle(el);
                const bgImage = cs.backgroundImage;
                if (bgImage && bgImage !== 'none' && bgImage.indexOf('gradient') !== -1) return { css: bgImage };
                const bgColor = cs.backgroundColor;
                if (bgColor && bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') return { css: bgColor };
                const inline = el.style.background || el.style.backgroundImage || el.style.backgroundColor;
                if (inline) return { css: inline };
              } catch (e) {
                // ignore and fallback
              }
              return null;
            }

            const hrefMap = {
              'plaques': 'Plaque/plaques.html',
              'suivi des plaques': 'Plaque/suiviplaque.html',
              'clients': 'Client/clients.html',
              'produits': 'Produit/produits.html',
              'conceptions': 'Conception/conceptions.html',
              'parametres': 'Parametres/parametres.html',
              'annonces': 'Annonces/annonces.html',
              'scan qr': 'Scan/scan.html',
              'tableau de bord': 'index.html',
              'dashboard': 'index.html',
              'accueil': 'index.html'
            };

            function guessHrefFromText(text) {
              if (!text) return null;
              const t = text.toLowerCase().replace(/\s+/g, ' ').trim();

              // match exact map or substring (existing)
              if (hrefMap[t]) return hrefMap[t];
              for (const key in hrefMap) if (t.includes(key)) return hrefMap[key];

              // token-based fallback: si le label contient à la fois "scan" et "qr"
              const words = t.split(/\s+/);
              if (words.includes('scan') && words.includes('qr')) return hrefMap['scan qr'];

              // autres cas : si contient 'scan' et 'plaque' -> aussi rediriger vers scan
              if (words.includes('scan') && words.includes('plaque')) return hrefMap['scan qr'];

              return null;
            }


            function getTargetHref(btn) {
              const dh = btn.getAttribute('data-href') || btn.getAttribute('data-url') || btn.dataset.href || btn.dataset.url;
              if (dh) return dh;
              const a = btn.querySelector('a[href]');
              if (a) return a.getAttribute('href');
              const text = (btn.textContent || '').trim();
              const guess = guessHrefFromText(text);
              if (guess) return guess;
              return null;
            }

            function showOverlayThenRedirect(btn, href) {
              if (!href) return;
              if (reduceMotion) {
                // navigation directe, same-origin assumed
                window.location.assign(href);
                return;
              }

              const bg = pickBackgroundFromElement(btn) || { css: 'rgba(0,0,0,0.85)' };
              const ov = ensureOverlay();

              try {
                if (bg.css && bg.css.indexOf && bg.css.indexOf('gradient') !== -1) {
                  ov.style.backgroundImage = bg.css;
                  ov.style.backgroundColor = '';
                } else if (bg.css) {
                  ov.style.backgroundImage = 'none';
                  ov.style.backgroundColor = bg.css;
                } else {
                  ov.style.backgroundImage = 'none';
                  ov.style.backgroundColor = 'rgba(0,0,0,0.85)';
                }
              } catch (e) {
                ov.style.backgroundImage = 'none';
                ov.style.backgroundColor = 'rgba(0,0,0,0.85)';
              }

              // bloque interactions
              buttons.forEach(b => b.disabled = true);
              // forcer reflow + afficher
              void ov.offsetWidth;
              ov.classList.add('show');

              setTimeout(() => {
                // redirection (relative URL)
                window.location.assign(href);
              }, ANIM_DURATION);
            }

            // attache handlers
            buttons.forEach(btn => {
              btn.addEventListener('click', (e) => {
                if (btn.hasAttribute('data-no-transition')) return;
                const href = getTargetHref(btn);
                if (!href) return; // laisse comportement par défaut si aucun href trouvé
                e.preventDefault();
                showOverlayThenRedirect(btn, href);
              });
            });

            // ESC pour retirer overlay si présent
            document.addEventListener('keydown', (e) => {
              if (e.key === 'Escape' && overlay && overlay.classList.contains('show')) {
                overlay.classList.remove('show');
                buttons.forEach(b => b.disabled = false);
                setTimeout(() => {
                  if (overlay) { overlay.remove(); overlay = null; }
                }, Math.max(ANIM_DURATION, 200));
              }
            });
          }
        }

        /* ------------------ Sidebar / notifications (UNIFIÉ overlay via classe .visible) ------------------ */
        const burgerBtn = document.querySelector('.header .burger');
        const closeBtn = document.querySelector('.sidebar .close-sidebar');
        const sidebar = document.querySelector('.sidebar');
        const notifBtn = document.querySelector('.notif-user');
        const sidenotifEl = document.querySelector('.sidenotif');
        const filterOverlay = document.querySelector('.filterblack');

        if (!filterOverlay) throw new Error('filterOverlay non trouvé');

        filterOverlay.style.transition = 'opacity 0.3s ease'; // laisse le CSS gérer display/opacité via la classe

        // assure état initial cohérent (on laisse le CSS gérer display via .visible)
        filterOverlay.classList.remove('visible');
        if (sidebar) { sidebar.style.transform = 'translateX(-100%)'; sidebar.style.transition = 'transform 0.3s ease'; }
        if (sidenotifEl) { sidenotifEl.style.transform = 'translateX(100%)'; sidenotifEl.style.transition = 'transform 0.3s ease'; sidenotifEl.addEventListener('click', e => e.stopPropagation()); }

        let sidebarOpen = false, notifOpen = false;

        function showOverlay() {
          filterOverlay.classList.add('visible'); // CSS .filterblack.visible { display:block; opacity:0.8; }
          // ensure it's visible for screen readers/interaction if needed
          filterOverlay.setAttribute('aria-hidden', 'false');
        }
        function hideOverlayIfNeeded() {
          if (!sidebarOpen && !notifOpen) {
            filterOverlay.classList.remove('visible');
            filterOverlay.setAttribute('aria-hidden', 'true');
          }
        }

        // open/close qui gardent la logique existante + overlay via classe
        function openSidebar() {
          if (!sidebar) return;
          sidebar.style.transform = 'translateX(0)';
          sidebarOpen = true;
          showOverlay();
        }
        function closeSidebar() {
          if (!sidebar) return;
          sidebar.style.transform = 'translateX(-100%)';
          sidebarOpen = false;
          hideOverlayIfNeeded();
        }
        function openNotif() {
          if (!sidenotifEl) return;
          sidenotifEl.style.transform = 'translateX(0)';
          notifOpen = true;
          showOverlay();
        }
        function closeNotif() {
          if (!sidenotifEl) return;
          sidenotifEl.style.transform = 'translateX(100%)';
          notifOpen = false;
          hideOverlayIfNeeded();
        }

        // handlers
        if (burgerBtn) burgerBtn.addEventListener('click', (e) => { e.stopPropagation(); openSidebar(); });
        if (closeBtn) closeBtn.addEventListener('click', (e) => { e.stopPropagation(); closeSidebar(); });
        if (filterOverlay) filterOverlay.addEventListener('click', () => { if (sidebarOpen) closeSidebar(); if (notifOpen) closeNotif(); });
        if (notifBtn) notifBtn.addEventListener('click', (e) => { e.stopPropagation(); notifOpen ? closeNotif() : openNotif(); });

        // accessibility: fermer avec Escape
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            if (sidebarOpen) closeSidebar();
            if (notifOpen) closeNotif();
          }
        });

        /* ------------------ Vérification d'authentification & déconnexion ------------------ */
        (async function checkAuthAndBindLogout() {
          try {
            const res = await fetch('/auth/me', {
              method: 'GET',
              credentials: 'include' // Important pour les cookies
            });

            if (!res.ok) {
              window.location.replace('login.html');
              return;
            }

            const userData = await res.json();
            console.log('Utilisateur connecté:', userData);

            // Gestion de la déconnexion
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
              logoutBtn.addEventListener('click', async () => {
                await fetch('/auth/logout', {
                  method: 'POST',
                  credentials: 'include'
                });
                window.location.replace('login.html');
              });
            }
          } catch (err) {
            console.error('Erreur de vérification auth:', err);
            window.location.replace('login.html');
          }
        })();

      }); // DOMContentLoaded
    })();

    document.addEventListener('DOMContentLoaded', function () {
      const notifContainer = document.querySelector('.sidenotif .notif-elements');
      const notifCountEl = document.querySelector('.notif-count');
      const notifBtn = document.querySelector('.notif-user');
      const sidenotifEl = document.querySelector('.sidenotif');
      const API_BASE = ''; // même origine
      const POLL_INTERVAL = 15000; // 15s

      function getCsrfToken() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        if (meta) return meta.getAttribute('content');
        const cookie = document.cookie.split('; ').find(c => c.trim().startsWith('XSRF-TOKEN='));
        if (cookie) return decodeURIComponent(cookie.split('=')[1]);
        return '';
      }

      async function getUserInfo() {
        // if DOM has prefilled data-user-id/role, use it
        try {
          if (sidenotifEl && sidenotifEl.dataset && (sidenotifEl.dataset.userId || sidenotifEl.dataset.role)) {
            return { id: sidenotifEl.dataset.userId || null, role: sidenotifEl.dataset.role || null };
          }
          const r = await fetch('/auth/me', { method: 'GET', credentials: 'include' });
          if (!r.ok) {
            console.warn('/auth/me not OK', r.status);
            return { id: null, role: null };
          }
          const data = await r.json();
          // normalise possible keys
          const id = data.id || data.user_id || data.id_utilisateur || null;
          const role = data.role || (data.employe && data.employe.role) || null;
          console.log('getUserInfo ->', { id, role, raw: data });
          return { id, role };
        } catch (e) {
          console.error('getUserInfo error', e);
          return { id: null, role: null };
        }
      }

      async function fetchNotificationsFor(user) {
        if (!user) user = await getUserInfo();
        if (!user) user = { id: null, role: null };
        const params = [];
        if (user.id) params.push('user_id=' + encodeURIComponent(user.id));
        if (user.role) params.push('role=' + encodeURIComponent(user.role));
        const qs = params.length ? ('?' + params.join('&')) : '';
        const url = `${API_BASE}/notifications${qs}&limit=500`.replace('?&', '?');
        console.log('fetchNotifications url:', url);
        try {
          const res = await fetch(url, { method: 'GET', credentials: 'include', headers: { 'Accept': 'application/json' } });
          if (!res.ok) {
            console.warn('fetchNotifications non OK', res.status);
            const txt = await res.text();
            console.warn('fetch body:', txt);
            return [];
          }
          const data = await res.json();
          const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
          console.log('fetchNotifications result count', items.length);
          return items;
        } catch (e) {
          console.error('Erreur fetchNotifications', e);
          return [];
        }
      }

      function formatNotificationDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const now = new Date();
        const days = Math.floor((now - date) / (1000 * 60 * 60 * 24));
        if (days === 0) return "Aujourd'hui";
        if (days === 1) return "Hier";
        if (days < 7) return `Il y a ${days} jours`;
        return date.toLocaleDateString('fr-FR');
      }

      function createNotificationHTML(notification) {
        const isRead = !!(notification.lue || notification.read);
        let iconSrc = '../img/icon/info.png';
        const type = notification.type_notif || notification.type;
        if (type === 'ajout_plaque') iconSrc = '../img/icon/info.png';
        if (type === 'renouvellement_plaque') iconSrc = '../img/icon/info.png';

        const id = notification.id_notification || notification.id || '';
        const msg = (notification.message || notification.text || notification.title || 'Nouvelle notification')
          .replace(/</g, '&lt;').replace(/>/g, '&gt;');

        return `
      <div class="notif-card ${isRead ? 'notif-read' : 'notif-unread'}" data-id="${id}"
           data-target-conception="${notification.id_conception || ''}"
           data-type="${type}">
        <div class="notif-card-icon"><img src="${iconSrc}" alt="icon"></div>
        <div class="notif-card-text">
          <p>${msg}</p>
          <small>${formatNotificationDate(notification.date_creation || notification.created_at)}</small>
        </div>
      </div>
    `;
      }

      function renderNotifications(notifications) {
        if (!notifContainer) return;
        if (!notifications || notifications.length === 0) {
          notifContainer.innerHTML = `<div class="notif-empty"><p>Aucune notification</p></div>`;
          if (notifCountEl) { notifCountEl.textContent = '0'; notifCountEl.style.display = 'none'; }
          return;
        }
        const byDate = {};
        (notifications || []).forEach(n => {
          const key = formatNotificationDate(n.date_creation || n.created_at || n.date) || 'Autre';
          (byDate[key] = byDate[key] || []).push(n);
        });
        let html = '';
        Object.keys(byDate).forEach(date => {
          html += `<div class="notif-day"><h3>${date}</h3></div>`;
          byDate[date].forEach(n => html += createNotificationHTML(n));
        });
        notifContainer.innerHTML = html;

        const unread = notifications.filter(n => !(n.lue || n.read)).length;
        if (notifCountEl) {
          notifCountEl.textContent = String(unread);
          notifCountEl.style.display = unread > 0 ? 'inline-block' : 'none';
        }
      }

      async function markAsReadLocal(notificationId, user) {
        if (!notificationId) return false;
        user = user || await getUserInfo();
        const params = [];
        if (user.id) params.push('user_id=' + encodeURIComponent(user.id));
        if (user.role) params.push('role=' + encodeURIComponent(user.role));
        const qs = params.length ? ('?' + params.join('&')) : '';
        const url = `${API_BASE}/notifications/mark_read${qs}`;
        console.log('markAsReadLocal ->', url, 'payload', notificationId);
        try {
          const res = await fetch(url, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrfToken() || '' },
            body: JSON.stringify({ id_notification: notificationId })
          });
          if (!res.ok) {
            console.warn('mark_read failed', res.status, await res.text());
            return false;
          }
          console.log('mark_read ok', await res.json());
          return true;
        } catch (e) {
          console.error('markAsReadLocal error', e);
          return false;
        }
      }

      async function markAllRead(user) {
        user = user || await getUserInfo();
        if (!user) { console.warn('markAllRead: no user'); return false; }
        const params = [];
        if (user.id) params.push('user_id=' + encodeURIComponent(user.id));
        if (user.role) params.push('role=' + encodeURIComponent(user.role));
        if (!params.length) { console.warn('markAllRead: no user_id or role'); return false; }
        const url = `${API_BASE}/notifications/mark_all_read?${params.join('&')}`;
        console.log('markAllRead ->', url);
        try {
          const res = await fetch(url, { method: 'POST', credentials: 'include', headers: { 'X-CSRF-Token': getCsrfToken() || '' } });
          if (!res.ok) {
            console.warn('markAllRead non OK', res.status);
            console.warn('body', await res.text());
            return false;
          }
          console.log('markAllRead ok', await res.json());
          return true;
        } catch (e) {
          console.error('Erreur markAllRead', e);
          return false;
        }
      }

      // Delegation click on card
      if (notifContainer) {
        notifContainer.addEventListener('click', async function (e) {
          const card = e.target.closest('.notif-card');
          if (!card) return;
          const id = card.dataset.id;
          // optimistic UI
          card.classList.add('notif-read');
          card.classList.remove('notif-unread');
          if (notifCountEl) {
            const current = parseInt(notifCountEl.textContent || '0', 10);
            const newVal = Math.max(0, current - 1);
            notifCountEl.textContent = String(newVal);
            notifCountEl.style.display = newVal > 0 ? 'inline-block' : 'none';
          }
          const user = await getUserInfo();
          await markAsReadLocal(id, user);
          const idConception = card.dataset.targetConception;
          if (idConception) {
            window.location.href = `/Conception/conception.html?id=${encodeURIComponent(idConception)}`;
            return;
          }
          window.dispatchEvent(new Event('closeNotificationsPanel'));
        });
      }

      if (notifBtn) {
        notifBtn.addEventListener('click', async function (e) {
          const user = await getUserInfo();
          const ok = await markAllRead(user);
          if (ok) {
            document.querySelectorAll('.sidenotif .notif-card').forEach(c => { c.classList.add('notif-read'); c.classList.remove('notif-unread'); });
            if (notifCountEl) { notifCountEl.textContent = '0'; notifCountEl.style.display = 'none'; }
          }
          // reload to catch server state
          setTimeout(loadNotifications, 300);
        });
      }

      async function loadNotifications() {
        const user = await getUserInfo();
        console.log('loadNotifications for', user);
        const arr = await fetchNotificationsFor(user);
        renderNotifications(arr);
      }

      // initial + polling
      loadNotifications();
      setInterval(loadNotifications, POLL_INTERVAL);

      // Expose for debug in console
      window.__notif_debug = {
        loadNotifications,
        fetchNotificationsFor,
        markAllRead,
        markAsReadLocal,
        getUserInfo
      };
      console.log('notification debug helper available at window.__notif_debug');
    });
  </script>

  <script src="newplaque.js?v=2"></script>
</body>

</html>