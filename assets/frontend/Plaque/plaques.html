<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../style-index.css">
  <title>EmballageBI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
    rel="stylesheet">
  <script src="../runtime_config.js"></script>
  <script>
    // force explicit API_BASE (tu as déjà ça)
    window.API_BASE = "https://emballage-b-impression.dz/emballage_bi";
    // Sauvegarde immédiate de la vraie fetch native AVANT que d'autres scripts puissent l'écraser
    if (!window.__API_NATIVE_FETCH_BACKUP) {
      try {
        window.__API_NATIVE_FETCH_BACKUP = window.fetch.bind(window);
        console.log('runtime_config forced:', window.API_BASE, ' — native fetch backed up.');
      } catch (e) {
        console.warn('Impossible de binder fetch native:', e);
      }
    }
  </script>
  <!-- api wrapper depends on window.API_BASE -->
  <script src="../api.js"></script>
  <!-- verify-connected uses api/buildApiUrl & binds logout -->
  <script src="../verify-connected.js"></script>
  <script src="../notification.js"></script>
  <script src="../ui-shell.js"></script>
  <script src="../table.js"></script>
  <link rel="stylesheet" href="../notif.css">
  <link rel="stylesheet" href="../responsive.css">
</head>
<style>
  .index-start {
    background: #639ED4;
    background: linear-gradient(180deg, rgba(99, 158, 212, 1) 0%, rgba(47, 94, 138, 1) 100%);
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .index-container {
    animation: fadeInUp;
    animation-duration: 0.5s;
  }

  .floating-thead {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    z-index: 50;
    /* énorme mais sûr */
    pointer-events: auto;
    /* laisse interagir les inputs/boutons */
    overflow: hidden;
    background: transparent;
    background-color: #3b3b3b;
  }

  .floating-thead table {
    border-collapse: collapse;
    table-layout: fixed;
    width: 100%;
  }

  .floating-thead thead th {
    background: #3b3b3b;
    color: white;
  }

  .actions {
    height: 100% !important;
    padding-left: 0 !important;
  }

  .main-row {
    margin-bottom: 10px !important;
  }

  .actions {
    padding-left: 5px;
  }

  .actions div button {
    width: 50px !important;
    height: 50px !important;
    font-size: 18px;
    display: inline-block;
    outline: 0;
    border: 0;
    cursor: pointer;
    will-change: box-shadow, transform;
    background: radial-gradient(100% 100% at 100% 0%, #89E5FF 0%, #5468FF 100%);
    box-shadow: 0px 0.01em 0.01em rgb(45 35 66 / 40%), 0px 0.3em 0.7em -0.01em rgb(45 35 66 / 30%), inset 0px -0.01em 0px rgb(58 65 111 / 50%);
    padding: 0 0.5em;
    border-radius: 0.3em;
    color: #fff;
    height: 2.6em;
    text-shadow: 0 1px 0 rgb(0 0 0 / 40%);
    transition: box-shadow 0.15s ease, transform 0.15s ease;
  }

  .actions div button:hover {
    box-shadow: 0px 0.1em 0.2em rgb(45 35 66 / 40%), 0px 0.4em 0.7em -0.1em rgb(45 35 66 / 30%), inset 0px -0.1em 0px #3c4fe0;
    transform: translateY(-0.1em);
  }

  .actions div button:active {
    box-shadow: inset 0px 0.1em 0.6em #3c4fe0;
    transform: translateY(0em);
  }

  .view img,
  .edit img {
    margin: 0 !important;
    padding: 0 !important;
    width: 20px !important;
    height: 20px !important;
  }







  .index-start .logo {
    width: 30% !important;
  }

  .index-start .logo img {
    width: 60px !important;
    height: 60px !important;
    display: block;
    transition: transform 0.25s ease;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    /* propre sur mobile */
  }

  .index-start .logo img:hover,
  .index-start .logo img:focus {
    transform: scale(1.05);
    /* Agrandit de 5% */
  }

  .index-start .logo img:active {
    transform: scale(1.00);
  }

  .index-start .logo .title-logo h1 {
    font-size: 30px !important;
    width: 300px !important;
    top: 10px !important;
  }

  .index-start .logo .title-logo p {
    font-size: 18px !important;
    color: rgb(255, 36, 36);
    margin: 0;
    padding: 0;
    position: absolute;
    bottom: -3px !important;
    right: -40px !important;
    font-weight: 600;
  }

  .returnBtn img {
    width: 30px;
    height: 30px;
    filter: invert(1);
  }

  .returnBtn img:hover {
    opacity: 0.5;
    cursor: pointer;
    transition: 0.3s ease;
  }

  /* Sidebar & sidenotif mobile-friendly */
  .sidebar,
  .sidenotif {
    position: fixed;
    top: 0;
    height: 100vh;
    z-index: 10001;
    will-change: transform;
    touch-action: pan-y;
    /* on permet le scroll vertical, on gère horizontal manuellement */
    -webkit-overflow-scrolling: touch;
  }

  /* largeur par défaut (desktop) */
  .sidebar {
    left: 0;
    width: 280px;
    transform: translateX(-100%);
    transition: transform 280ms ease;
  }

  .sidenotif {
    right: 0;
    width: 360px;
    transform: translateX(100%);
    transition: transform 280ms ease;
  }

  /* overlay (déjà .filterblack dans ton HTML, on s'assure du style) */
  .filterblack {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    display: none;
    opacity: 0;
    transition: opacity 220ms ease;
    -webkit-tap-highlight-color: transparent;
  }

  /* état ouvert (JS ajoute/retire ces classes) */
  .sidebar.open {
    transform: translateX(0) !important;
  }

  .sidenotif.open {
    transform: translateX(0) !important;
  }

  .filterblack.visible {
    display: block;
    opacity: 0.8;
  }

  /* Ajustements responsive : faire icônes visibles sur téléphone si besoin */
  @media (max-width: 900px) {
    .sidebar {
      width: 78vw;
      max-width: 360px;
    }

    .sidenotif {
      width: 86vw;
      max-width: 420px;
    }

    .header .burger img {
      width: 26px;
      height: 26px;
    }

    /* icône plus petite */
  }

  /* Interaction tactile pendant le drag : disable transition while dragging */
  .sidebar.dragging,
  .sidenotif.dragging {
    transition: none !important;
  }






  .lignes-table {
    background-color: #efefef;
  }

  .sub-wrapper {
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
    border-bottom: 2px solid black;
    border-left: 2px solid black;
    border-right: 2px solid black;
    overflow: hidden;
    background-color: #efefef;
    transition: max-height 300ms ease;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    margin-bottom: 10px;
  }

  td[colspan="6"] {
    background-color: #efefef !important;
  }

  td[colspan="7"] {
    background-color: #efefef !important;
  }


  .table-wrapper {
    position: relative;
    z-index: 0;
  }

  /* Faire en sorte que l'entête principal soit au-dessus */
  .table-wrapper table.main thead.main-head {
    position: relative;
    /* z-index ne fonctionne que si l'élément est positionné */
    z-index: 50;
    background: #fff;
    /* éviter transparence qui permet aux éléments en dessous d'apparaître */
  }

  /* Sub-table au dessous (si jamais elle a z-index plus élevé par défaut) */
  .table-wrapper table.sub thead {
    position: relative;
    z-index: 10;
    background: transparent;
    /* ou la même couleur mais z-index plus petit */
  }

  /* supprimer espace entre cellules qui casse les ombres */
  .table-wrapper table {
    border-collapse: separate;
    /* laisser separate pour gérer border-radius */
    border-spacing: 0;
    /* important pour éviter gaps */
  }

  /* Padding global pour les tds et éviter margins dans les cartes */
  .table-wrapper table.main tbody tr.main-row td {
    padding: 8px;
    /* l'espace autour de la "card" */
    vertical-align: middle;
  }

  /* Style commun pour la "card" (mettre la classe .card sur le div intérieur) */
  .table-wrapper .card {
    margin: 0;
    /* IMPORTANT: enlever margin qui crée des espaces */
    height: 100px;
    /* ou ajuste selon besoin */
    display: flex;
    align-items: center;
    padding: 10px 16px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.10);
    background-color: #e0e0e0;
    overflow: hidden;
  }

  /* arrondir seulement les coins des premières/dernières colonnes */
  .table-wrapper table.main tbody tr.main-row td:first-child .card {
    border-top-left-radius: 10px;
    border-bottom-left-radius: 10px;
  }

  .table-wrapper table.main tbody tr.main-row td:last-child .card {
    border-top-right-radius: 10px;
    border-bottom-right-radius: 10px;
  }

  /* si tu veux que les boutons/actions aient leur propre arrondi */
  .table-wrapper table.main tbody tr.main-row td.actions .card {
    border-radius: 10px;
  }

  .all-plaques {
    width: 100%;
    height: calc(100% - 50px);

    overflow-y: scroll;
  }

  .filter-plaque {
    width: 100%;
    height: 50px;
    display: flex;
    justify-content: flex-start;
    align-items: center;
  }

  .filter-plaque .inputSearchPlaque {
    width: 300px;
    height: 40px;
    background-color: white;
    display: flex;
    justify-content: flex-start;
    align-items: center;
    border-radius: 10px;
    margin-left: 10px;
    border: 1px solid rgb(179, 179, 179);
  }

  .filter-plaque .inputSearchPlaque:hover {
    cursor: pointer;
    transform: translate(0px, -1px);
    transition: 0.3s ease;
  }

  .filter-plaque .inputSearchPlaque:active {
    transform: translate(0px, 2px);
    transition: 0.3s ease;
  }

  .filter-plaque .inputSearchPlaque img {
    width: 20px;
    height: 20px;
    margin-left: 10px;
    filter: invert(100%);
  }

  .filter-plaque .inputSearchPlaque input {
    width: calc(100% - 50px);
    height: 25px;
    border: none;
    outline: none;
    padding-left: 10px;
    background-color: white;
    border: none;
    padding-left: 5px;
  }

  /* === Nouveau style pour .plaque-container (ne touche pas à .all-plaques) === */

  /* Variables utiles (facultatives) */
  :root {
    --pc-bg: #f3f4f6;
    --pc-accent: #111;
    --pc-muted: #6b6b6b;
    --pc-red: #d9534f;
    --pc-green: #2ca84f;
    --pc-radius: 12px;
    --pc-shadow: 0 6px 18px rgba(15, 15, 15, 0.08);
    --pc-compact-gap: 12px;
  }

  /* Container principal */
  .all-plaques .plaque-container {
    width: calc(100% - 20px);
    height: 120px;
    display: flex;
    gap: var(--pc-compact-gap);
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    background-color: var(--pc-bg);
    border-radius: var(--pc-radius);
    margin: 10px;
    cursor: pointer;
    transition: transform .18s ease, box-shadow .18s ease;
    box-shadow: var(--pc-shadow);
    box-sizing: border-box;
    overflow: hidden;
  }

  /* Hover / focus */
  .all-plaques .plaque-container:hover,
  .all-plaques .plaque-container:focus {
    transform: translateY(-4px);
    box-shadow: 0 16px 30px rgba(15, 15, 15, 0.12);
    outline: none;
  }

  /* Thumbnail image (réduite et contenue correctement) */
  .all-plaques .plaque-container .thumbPlaque {
    flex: 0 0 84px;
    /* espace réservé */
    width: 84px;
    height: 84px;
    border: 1px solid rgba(160, 160, 160, 0.35);
    border-radius: 10px;
    padding: 8px;
    background-color: #fff;
    box-sizing: border-box;
    object-fit: contain;
    /* évite déformation des images */
    display: block;
    margin: 0;
  }

  /* Zone texte (client+produit) : prend le max d'espace disponible */
  .all-plaques .plaque-container .clientProduitCouple {
    flex: 1 1 auto;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-start;
    gap: 6px;
    min-width: 0;
    /* important pour text-overflow */
  }

  /* Numero design (plus fluide que width fixe) */
  .all-plaques .plaque-container .clientProduitCouple h1 {
    display: inline-block;
    margin: 0;
    padding: 6px 12px;
    font-size: 18px;
    font-family: "Nunito", sans-serif;
    color: #fff;
    background-color: var(--pc-accent);
    border-radius: 8px;
    line-height: 1;
    white-space: nowrap;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
  }

  /* Paragraphes : texte long tronqué proprement */
  .all-plaques .plaque-container .clientProduitCouple p {
    font-family: "Nunito", sans-serif;
    color: var(--pc-muted);
    margin: 0;
    padding: 0;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 0;
    /* permet ellipsis */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* petites icônes inline */
  .all-plaques .plaque-container .clientProduitCouple p img {
    width: 16px;
    height: 16px;
    flex: 0 0 16px;
    object-fit: contain;
  }

  /* Statut : centré et compact */
  .all-plaques .plaque-container .statut-plaque {
    flex: 0 0 140px;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: "Nunito", sans-serif;
    font-size: 13px;
    box-sizing: border-box;
  }

  /* badge statut */
  .all-plaques .plaque-container .statut-plaque p {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    border-radius: 10px;
    background-color: #fafafa;
    color: #111;
    margin: 0;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.06);
    border: 1px solid rgba(0, 0, 0, 0.06);
    font-weight: 600;
  }

  /* icône dans statut */
  .all-plaques .plaque-container .statut-plaque img {
    width: 14px;
    height: 14px;
    flex: 0 0 14px;
    object-fit: contain;
  }

  /* Date mise à jour : plus discrète */
  .all-plaques .plaque-container .dateMiseAjour {
    flex: 0 0 110px;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-end;
    box-sizing: border-box;
    padding-right: 6px;
  }

  .all-plaques .plaque-container .dateMiseAjour p {
    font-size: 12px;
    font-family: "Nunito", sans-serif;
    margin: 0;
    padding: 0;
    color: var(--pc-muted);
  }

  /* Actions : boutons compacts et adaptatifs */
  .all-plaques .plaque-container .actionPlaque {
    flex: 0 0 220px;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    box-sizing: border-box;
  }

  /* Boutons : responsive, icônes réduites */
  .all-plaques .plaque-container .actionPlaque button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    min-width: 92px;
    height: 40px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: transform .12s ease, box-shadow .12s ease;
    color: #fff;
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
    font-family: "Nunito", sans-serif;
    font-size: 13px;
  }

  .all-plaques .plaque-container .actionPlaque button:active {
    transform: translateY(1px) scale(.995);
  }

  /* couleurs spécifiques */
  .all-plaques .plaque-container .actionPlaque button.btn1 {
    background-color: var(--pc-red);
  }

  .all-plaques .plaque-container .actionPlaque button.btn2 {
    background-color: var(--pc-green);
  }

  /* icônes dans boutons */
  .all-plaques .plaque-container .actionPlaque button img {
    width: 18px;
    height: 18px;
    flex: 0 0 18px;
    object-fit: contain;
  }

  @media (max-width: 1080px) {

    /* Sur petits écrans, empiler colonne de droite sous la zone principale */
    .all-plaques .plaque-container {
      flex-direction: row;
      flex-wrap: wrap;
      height: auto;
    }

    .all-plaques .plaque-container .thumbPlaque {
      flex: 0 0 68px;
      width: 68px;
      height: 68px;
    }

    .all-plaques .plaque-container .clientProduitCouple {
      order: 2;
      width: calc(100% - 84px);
      padding-right: 8px;
    }

    .all-plaques .plaque-container .statut-plaque {
      order: 3;
      flex: 0 0 50%;
      justify-content: flex-start;
    }

    .all-plaques .plaque-container .dateMiseAjour {
      order: 4;
      flex: 0 0 50%;
      align-items: flex-start;
      padding-left: 0;
    }

    .all-plaques .plaque-container .actionPlaque {
      order: 5;
      width: 100%;
      gap: 8px;
      justify-content: flex-start;
      padding-top: 6px;
    }

    .all-plaques .plaque-container .actionPlaque button {
      min-width: 120px;
      flex: 0 0 auto;
    }
  }

  @media (max-width: 420px) {
    .all-plaques .plaque-container .clientProduitCouple p {
      font-size: 12px;
    }

    .all-plaques .plaque-container .clientProduitCouple h1 {
      font-size: 16px;
      padding: 5px 10px;
    }

    .all-plaques .plaque-container .actionPlaque button {
      padding: 8px 10px;
      min-width: 100px;
      font-size: 12px;
    }
  }


  .status .status-pin {
    width: 8px !important;
    height: 8px !important;
    margin-right: 6px !important;
    vertical-align: middle !important;
  }
</style>

<body>
  <div class="filterblack"></div>
  <div class="sidenotif" data-user-id="">
    <div class="notif-header">
      <img src="../img/icon/notifications.png">
      <h2>Notifications</h2>
    </div>
    <div class="notif-elements" style="width: 360px !important;">
      <div class="notif-loading">
        <p>Chargement des notifications...</p>
      </div>
    </div>
  </div>
  <div class="sidebar">
    <img src="../img/icon/menu.png" alt="Close" class="close-sidebar">
    <div class="logo">
      <img src="../img/logoblanc.png" alt="EmballageBI">
      <div class="title-logo">
        <h1>Emballage BI</h1>
        <p>2026</p>
      </div>
    </div>
    <nav class="sidebar-nav">
      <ul>
        <li onclick="window.location.href = '../index.html'" onclick="window.location.href = '../index.html'"><a
            href="#"><img src="../img/icon/home.png" alt="Home"> Tableau de bord</a></li>
        <hr>
        <li onclick="window.location.href = '../Plaque/suiviplaque.html'"><a href="#"><img
              src="../img/icon/papeterie-papiers-empiles.png" alt="Plaques"> Suivi des Plaques</a></li>
        <li onclick="window.location.href = '../Plaque/plaques.html'"><a href="#"><img src="../img/icon/plaques.png"
              alt="Plaques"> Plaques</a></li>
        <hr>
        <li onclick="window.location.href = '../Client/clients.html'"><a href="#"><img src="../img/icon/client.png"
              alt="Client"> Clients</a></li>
        <li onclick="window.location.href = '../Produit/produits.html'"><a href="#"><img
              src="../img/icon/produit - Copie.png" alt="Produit"> Produits</a></li>
        <li onclick="window.location.href = '../Conception/conceptions.html'"><a href="#"><img
              src="../img/icon/personnalisation1.png" alt="Conception"> Conceptions</a></li>
        <hr>
        <li onclick="window.location.href = '../Scan/scan.html'"><a href="#"><img src="../img/icon/qrcode.png" alt="QR">
            Scan
            QR</a></li>
        <li onclick="window.location.href = '../Annonces/annonces.html'"><a href="#"><img src="../img/icon/annonce.png"
              alt="Annonces"> Annonces</a></li>
        <hr>
        <li onclick="window.location.href = '../User/profil.html'"><a href="#"><img src="../img/icon/user.png"
              alt="User">
            Profil</a></li>
        <li onclick="window.location.href = '../Parametres/parametres.html'"><a href="#"><img
              src="../img/icon/parametres.png" alt="Parametres"> Parametres</a></li>

      </ul>
      <a href="#" id="logoutBtn"><img src="../img/icon/se-deconnecter.png" alt="Parametres"> Se deconnecter</a>
    </nav>
  </div>
  <div class="index-start">
    <div class="header" style="justify-content: space-evenly;">
      <div class="user-space" style="display: flex;justify-content: flex-start;width: 15%;">
        <div class="burger" style="margin-left: 30px;">
          <img src="../img/icon/menu.png" alt="Menu">
        </div>
        <div class="returnBtn"
          style="margin-left: 40px;width: 40px;height: 40px;display: flex;justify-content: center;align-items: center;"
          onclick="window.location.href='../index.html'">
          <img src="../img/icon/retourner.png">
        </div>
      </div>
      <div class="logo" onclick="window.location.href='../index.html'">
        <img src="../img/logoblanc.png" alt="EmballageBI" data-red="../img/logorouge.png" tabindex="0" />
      </div>
      <div class="user-space" style="display: flex;justify-content: flex-end;width: 15%;">
        <div class="notif-user">
          <img src="../img/icon/notifications.png" alt="Notifications">
          <span class="notif-count">0</span>
        </div>
        <div class="user-info" onclick="window.location.href='../user/profil.html'">
          <img src="../img/icon/profil.png" alt="User">
        </div>
      </div>
    </div>
    <div class="index-container">
      <div class="linkpages">
        <a href="../index.html">Tableau de bord</a> > Plaques
      </div>
      <div class="all-onglets-container">
        <div class="btns-onglets">
          <div class="onglet active">
            <img src="../img/icon/papeterie-papiers-empiles.png" alt="Plaques">
            <span>Gestion des Plaques</span>
          </div>
          <div class="onglet">
            <img src="../img/icon/accord.png" alt="sous-traités">
            <span>Plaques sous-traités</span>
          </div>
          <div class="onglet">
            <img src="../img/icon/dollar.png" alt="commandées">
            <span>Plaques commandées</span>
          </div>
          <div class="onglet">
            <img src="../img/icon/question.png" alt="commandées">
            <span>Plaques en quarantaine</span>
          </div>
        </div>
        <div class="onglet-container">
          <div class="onglet-header">
            <div class="search-plaques">
              <img src="../img/icon/recherche.png" alt="Search">
              <input type="text" placeholder="Rechercher une plaque...">
            </div>
            <div class="btns-header">
              <button class="btn-add-plaque" type="button" style="background-color: #3b3b3b;"
                onclick="window.location.href='../Scan/scan.html?redirect=gestion'">
                <img src="../img/icon/qrcode.png" alt="Ajouter Plaque">
                <p>Scanner via QR Code</p>
              </button>
              <button class="btn-add-plaque" type="button" onclick="window.location.href='newplaque.html'">
                <img src="../img/icon/plus.png" alt="Ajouter Plaque">
                <p>AJOUTER UNE PLAQUE</p>
              </button>
            </div>
          </div>
          <div class="container">
            <div class="table-wrapper">
              <table class="main" id="mainTable" role="table" aria-label="Table principale"
                data-server-paginated="true">
                <thead class="main-head">
                  <tr style="background-color: #3b3b3b;">
                    <th style="width:16.66%;">
                      <div class="th-wrap">
                        <div class="col-filter">
                          <input data-col="0" class="col-search" placeholder="Recherchez..." />
                          <img src="../img/icon/recherche.png" alt="Rechercher">
                        </div>
                        <div class="col-title">
                          Conception
                          <span class="sort-btn" data-col="0" title="Trier">&#9650;</span>
                        </div>
                      </div>
                    </th>
                    <th style="width:16.66%;">
                      <div class="th-wrap">
                        <div class="col-filter">
                          <input data-col="1" class="col-search" placeholder="Recherchez..." />
                          <img src="../img/icon/recherche.png" alt="Rechercher">
                        </div>
                        <div class="col-title">
                          Client
                          <span class="sort-btn" data-col="1" title="Trier">&#9650;</span>
                        </div>
                      </div>
                    </th>
                    <th style="width:16.66%;">
                      <div class="th-wrap">
                        <div class="col-filter">
                          <input data-col="2" class="col-search" placeholder="Recherchez..." />
                          <img src="../img/icon/recherche.png" alt="Rechercher">
                        </div>
                        <div class="col-title">
                          Produit
                          <span class="sort-btn" data-col="2" title="Trier">&#9650;</span>
                        </div>
                      </div>
                    </th>

                    <th style="width:16.66%;">
                      <div class="th-wrap">
                        <div class="col-filter" style="background-color: transparent;">
                          <input data-col="2" class="col-search" style="opacity: 0;" placeholder="Recherchez..." />
                          <img src="../img/icon/recherche.png" alt="Rechercher" style="opacity: 0;">
                        </div>
                        <div class="col-title">
                          Nombre de pose
                          <span class="sort-btn" data-col="3" title="Trier">&#9650;</span>
                        </div>
                      </div>
                    </th>
                    <th style="width:16.66%;">
                      <div class="th-wrap">
                        <div class="col-filter">
                          <input data-col="4" class="col-search" placeholder="Recherchez..." />
                          <img src="../img/icon/recherche.png" alt="Rechercher">
                        </div>
                        <div class="col-title">
                          Nombre de plaque
                          <span class="sort-btn" data-col="4" title="Trier">&#9650;</span>
                        </div>
                      </div>
                    </th>
                    <th style="width:16.66%;"><!-- actions -->
                    </th>
                  </tr>
                </thead>

                <tbody class="lignes-table" style="width: 100% !important;">
                  <!-- Example row 1 -->
                  <!-- More rows... replicate as needed -->
                </tbody>
              </table>
            </div>
          </div>

          <div class="onglet-pagination">
            <p><b></b> PLAQUES</p>
            <div class="pagination">
            </div>
          </div>
        </div>
        <!-- Onglet: Plaques sous-traités (remplacer l'ancien placeholder) -->
        <div class="onglet-container" style="display: none; flex-direction: column;">
          <div class="onglet-header">
            <div class="search-plaques">
              <img src="../img/icon/recherche.png" alt="Search">
              <input type="text" placeholder="Rechercher une plaque...">
            </div>
            <div class="btns-header">
              <button class="btn-add-plaque" type="button" style="background-color: #3b3b3b;"
                onclick="window.location.href='../Scan/scan.html?redirect=gestion'">
                <img src="../img/icon/qrcode.png" alt="Ajouter Plaque">
                <p>Scanner via QR Code</p>
              </button>
              <button class="btn-add-plaque" type="button" onclick="window.location.href='newplaque.html'">
                <img src="../img/icon/plus.png" alt="Ajouter Plaque">
                <p>AJOUTER UNE PLAQUE</p>
              </button>
            </div>
          </div>
          <div class="container">
            <div class="table-wrapper">
              <table class="main" role="table" aria-label="Table principale - Sous-traités"
                data-server-paginated="true">
                <thead class="main-head">
                  <tr>
                    <th style="width:14.28%;">
                      <div class="th-wrap">
                        <div class="col-filter">
                          <input data-col="0" class="col-search" placeholder="Recherchez..." />
                          <img src="../img/icon/recherche.png" alt="Rechercher">
                        </div>
                        <div class="col-title">Conception <span class="sort-btn" data-col="0"
                            title="Trier">&#9650;</span></div>
                      </div>
                    </th>
                    <th style="width:14.28%;">
                      <div class="th-wrap">
                        <div class="col-filter">
                          <input data-col="1" class="col-search" placeholder="Recherchez..." />
                          <img src="../img/icon/recherche.png" alt="Rechercher">
                        </div>
                        <div class="col-title">Client <span class="sort-btn" data-col="1" title="Trier">&#9650;</span>
                        </div>
                      </div>
                    </th>
                    <th style="width:14.28%;">
                      <div class="th-wrap">
                        <div class="col-filter">
                          <input data-col="2" class="col-search" placeholder="Recherchez..." />
                          <img src="../img/icon/recherche.png" alt="Rechercher">
                        </div>
                        <div class="col-title">Produit <span class="sort-btn" data-col="2" title="Trier">&#9650;</span>
                        </div>
                      </div>
                    </th>
                    <!-- NOUVELLE COLONNE : Sous-traitant (pas de filtre pour l'instant) -->
                    <th style="width:14.28%;">
                      <div class="th-wrap">
                        <div class="col-filter">
                          <input data-col="5" class="col-search" placeholder="Recherchez..." />
                          <img src="../img/icon/recherche.png" alt="Rechercher">
                        </div>
                        <div class="col-title">Sous-traitant<span class="sort-btn" data-col="2"
                            title="Trier">&#9650;</span>
                        </div>
                      </div>
                    </th>
                    <th style="width:14.28%;">
                      <div class="th-wrap">
                        <div class="col-filter" style="background-color: transparent;">
                          <input data-col="2" class="col-search" style="opacity: 0;" placeholder="Recherchez..." />
                          <img src="../img/icon/recherche.png" alt="Rechercher" style="opacity: 0;">
                        </div>
                        <div class="col-title">Nombre de pose <span class="sort-btn" data-col="3"
                            title="Trier">&#9650;</span></div>
                      </div>
                    </th>
                    <th style="width:14.28%;">
                      <div class="th-wrap">
                        <div class="col-filter">
                          <input data-col="4" class="col-search" placeholder="Recherchez..." />
                          <img src="../img/icon/recherche.png" alt="Rechercher">
                        </div>
                        <div class="col-title">Nombre de plaque <span class="sort-btn" data-col="4"
                            title="Trier">&#9650;</span></div>
                      </div>
                    </th>
                    <th style="width:14.28%;"><!-- actions --></th>
                  </tr>
                </thead>

                <tbody class="lignes-table" style="width: 100% !important;">
                  <!-- rows will be injected by plaques.js -->
                </tbody>
              </table>
            </div>
          </div>

          <div class="onglet-pagination">
            <p><b></b> PLAQUES</p>
            <div class="pagination"></div>
          </div>
        </div>

        <div class="onglet-container" style="display: none;">
          <p>onglet 3</p>
        </div>
        <div class="onglet-container" id="ongletQuarantaine" style="display: none;">
          <div class="filter-plaque">
            <div class="inputSearchPlaque">
              <img src="../img/icon/recherche.png" alt="Rechercher">
              <input type="text" placeholder="Rechercher une plaque...">
            </div>
          </div>
          <div class="all-plaques">
            <div class="plaque-container">
              <img class="thumbPlaque" src="../img/icon/papeterie-papiers-empiles.png" alt="Aperçu plaque">
              <div class="clientProduitCouple">
                <h1>N° 1632</h1>
                <p><img src="../img/icon/profilclient.png" alt="clients">Client 1, Client 2, <b>...+2</b></p>
                <p><img src="../img/icon/produit - Copie.png" alt="produits">Boite Burger Standard, Boite Sandwich,
                  <b>...+2</b>
                </p>
              </div>
              <div class="statut-plaque">
                <p>
                  <img src="../img/icon/pointrouge.png" alt="">
                  En quarantaine
                </p>
              </div>
              <div class="dateMiseAjour">
                <p>23/08/2023</p>
              </div>
              <div class="actionPlaque">
                <button type="button" class="btn1">
                  <img src="../img/icon/arret.png" alt="">
                  Indisponible
                </button>
                <button type="button" class="btn2">
                  <img src="../img/icon/verifie.png" alt="">
                  Utilisable
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>



  <script>
    document.addEventListener('DOMContentLoaded', () => {

      /* ============================================================
         1) Floating thead (clone) - garde l'espace et synchronise largeurs
         ============================================================ */
      (function () {
        const wrapper = document.querySelector('.table-wrapper');
        const table = wrapper?.querySelector('table.main');
        if (!wrapper || !table) return;

        if (getComputedStyle(wrapper).position === 'static') {
          wrapper.style.position = 'relative';
        }

        const originalThead = table.querySelector('thead');
        if (!originalThead) return;

        const cloneContainer = document.createElement('div');
        cloneContainer.className = 'floating-thead';
        const cloneTable = document.createElement('table');
        cloneTable.className = table.className;
        const clonedThead = originalThead.cloneNode(true);
        cloneTable.appendChild(clonedThead);
        cloneContainer.appendChild(cloneTable);
        wrapper.appendChild(cloneContainer);

        originalThead.style.visibility = 'hidden';

        function syncWidths() {
          const tableRect = table.getBoundingClientRect();
          cloneTable.style.width = tableRect.width + 'px';

          const originalThs = Array.from(originalThead.querySelectorAll('th'));
          const cloneThs = Array.from(clonedThead.querySelectorAll('th'));

          if (originalThs.length !== cloneThs.length) {
            cloneThs.forEach(th => th.style.width = (tableRect.width / cloneThs.length) + 'px');
            return;
          }

          originalThs.forEach((oth, i) => {
            const w = Math.round(oth.getBoundingClientRect().width);
            cloneThs[i].style.boxSizing = 'border-box';
            cloneThs[i].style.width = w + 'px';
          });
        }

        window.addEventListener('load', syncWidths);
        window.addEventListener('resize', syncWidths);

        function onScroll() {
          const sy = wrapper.scrollTop;
          cloneContainer.style.transform = `translateY(${sy}px)`;
        }
        wrapper.addEventListener('scroll', onScroll);

        syncWidths();
        onScroll();

        // sync inputs between clone and original (si présents)
        const origInputs = Array.from(originalThead.querySelectorAll('input,select,button'));
        const cloneInputs = Array.from(clonedThead.querySelectorAll('input,select,button'));

        cloneInputs.forEach((ci, idx) => {
          const oi = origInputs[idx];
          if (!oi) return;
          ci.addEventListener('input', () => {
            if (oi.type === 'checkbox' || oi.type === 'radio') oi.checked = ci.checked;
            else oi.value = ci.value;
            oi.dispatchEvent(new Event('input', { bubbles: true }));
          });
          oi.addEventListener('input', () => {
            if (ci.type === 'checkbox' || ci.type === 'radio') ci.checked = oi.checked;
            else ci.value = oi.value;
          });
        });

        // forward click sur th clone -> th original
        clonedThead.querySelectorAll('th').forEach((thClone, idx) => {
          thClone.addEventListener('click', () => {
            const thOrig = originalThead.querySelectorAll('th')[idx];
            if (thOrig) thOrig.click();
          });
        });

        const obs = new MutationObserver(() => { setTimeout(syncWidths, 50); });
        obs.observe(table, { childList: true, subtree: true, attributes: true });
      })();


      /* ============================================================
         2) Sub-row toggler (animation d'ouverture/fermeture)
         ============================================================ */
      (function () {
        document.querySelectorAll('tr.sub-row').forEach(sub => {
          const main = sub.previousElementSibling;
          if (!main) return;

          const contentTd = sub.querySelector('td[colspan]') || sub.querySelector('td') || sub.firstElementChild;
          if (!contentTd) return;

          let wrapper = contentTd.querySelector('.sub-wrapper');
          if (!wrapper) {
            wrapper = document.createElement('div');
            wrapper.className = 'sub-wrapper';
            while (contentTd.firstChild) wrapper.appendChild(contentTd.firstChild);
            contentTd.appendChild(wrapper);
          }

          wrapper.style.overflow = 'hidden';
          wrapper.style.transition = 'max-height 300ms ease';
          wrapper.style.maxHeight = '0px';

          sub.dataset.open = 'false';
          if (getComputedStyle(sub).display !== 'table-row') sub.style.display = 'none';

          const img = main.querySelector('img.arrow');
          if (img) {
            img.style.transition = 'transform 300ms ease';
            img.style.transformOrigin = '50% 50%';
            img.style.transform = 'rotate(0deg)';
          }

          main.addEventListener('click', (ev) => {
            if (ev.target.closest('button') || ev.target.closest('a') || ev.target.closest('input')) return;

            const isOpen = sub.dataset.open === 'true';

            if (!isOpen) {
              sub.style.display = 'table-row';
              wrapper.style.maxHeight = '0px';
              requestAnimationFrame(() => {
                const full = wrapper.scrollHeight;
                wrapper.style.maxHeight = full + 'px';
              });
              sub.dataset.open = 'true';
              if (img) img.style.transform = 'rotate(90deg)';

              const onOpenEnd = (e) => {
                if (e.propertyName === 'max-height') {
                  wrapper.style.maxHeight = 'none';
                  wrapper.removeEventListener('transitionend', onOpenEnd);
                }
              };
              wrapper.addEventListener('transitionend', onOpenEnd);

            } else {
              wrapper.style.maxHeight = wrapper.scrollHeight + 'px';
              requestAnimationFrame(() => {
                wrapper.style.maxHeight = '0px';
              });
              sub.dataset.open = 'false';
              if (img) img.style.transform = 'rotate(0deg)';

              const onCloseEnd = (e) => {
                if (e.propertyName === 'max-height') {
                  sub.style.display = 'none';
                  wrapper.removeEventListener('transitionend', onCloseEnd);
                }
              };
              wrapper.addEventListener('transitionend', onCloseEnd);
            }
          });
        });
      })();


      /* ============================================================
      3) Pagination + compteur plaques + MAJ par-ligne
      ============================================================ */
      (function () {
        const rowsPerPage = 13; // ajuste si nécessaire

        // Si la table est pilotée par le serveur, on skip la pagination client-side
        // (cela évite conflit avec la pagination serveur).
        const firstContainer = document.querySelector('.all-onglets-container .onglet-container');
        if (firstContainer) {
          const serverTable = firstContainer.querySelector('table.main#mainTable');
          if (serverTable && serverTable.dataset && serverTable.dataset.serverPaginated === 'true') {
            // skip client-side pagination entirely
            return;
          }
        }

        document.querySelectorAll('.all-onglets-container .onglet-container').forEach(container => {
          const table = container.querySelector('table.main');
          const paginationWrap = container.querySelector('.onglet-pagination .pagination');
          const countB = container.querySelector('.onglet-pagination p b');
          if (!table || !paginationWrap || !countB) return;

          function getMainRows() {
            return Array.from(table.querySelectorAll('tr.main-row'));
          }

          // retourne le <tbody.sub-body> correspondant à une main-row (ou null)
          function getSubBodyForMain(mainRow) {
            const next = mainRow.nextElementSibling;
            if (!next || !next.classList.contains('sub-row')) return null;
            return next.querySelector('table.sub tbody.sub-body') || next.querySelector('tbody.sub-body') || next.querySelector('table.sub');
          }

          // calcule total global (somme des lignes dans chaque sub-body)
          function computeTotalPlaques() {
            let total = 0;
            const mains = getMainRows();
            mains.forEach(mainRow => {
              const subBody = getSubBodyForMain(mainRow);
              if (subBody) {
                const trs = subBody.querySelectorAll('tr');
                total += trs.length;
              }
            });
            return total;
          }

          // MET A JOUR le nombre affiché pour chaque ligne principale (colonne 3) et data-nb
          function updatePerRowCounts() {
            const mains = getMainRows();
            mains.forEach(mainRow => {
              const subBody = getSubBodyForMain(mainRow);
              const count = subBody ? subBody.querySelectorAll('tr').length : 0;

              // met à jour la cellule (3ème td si présent)
              const cells = mainRow.children;
              if (cells && cells.length >= 3) {
                // garde un format stable : "X Plaques"

              } else {
                // fallback : met un attribut data-nb si pas de cellule
                mainRow.dataset.nb = String(count);
              }
              // met à jour l'attribut data-nb aussi
              mainRow.dataset.nb = String(count);
            });
          }

          // variables
          let mainRows = getMainRows();
          let totalItems = mainRows.length;
          let totalPages = Math.max(1, Math.ceil(totalItems / rowsPerPage));
          let currentPage = 1;
          let paginationDebounce = null;

          // affiche page (met aussi à jour per-line counts et compteur global)
          function showPage(page) {
            mainRows = getMainRows();
            totalItems = mainRows.length;
            totalPages = Math.max(1, Math.ceil(totalItems / rowsPerPage));
            currentPage = Math.min(Math.max(1, page), totalPages);

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = currentPage * rowsPerPage;

            mainRows.forEach((mainRow, idx) => {
              const shouldShowMain = idx >= startIndex && idx < endIndex;
              mainRow.style.display = shouldShowMain ? 'table-row' : 'none';

              const next = mainRow.nextElementSibling;
              if (next && next.classList.contains('sub-row')) {
                // on affiche la sub-row uniquement si la main-row est visible AND elle est "open"
                next.style.display = shouldShowMain ? (next.dataset.open === 'true' ? 'table-row' : 'none') : 'none';
              }
            });

            // mettre à jour per-row counts et compteur global
            updatePerRowCounts();
            countB.textContent = String(computeTotalPlaques());

            // mise à jour des boutons visuels
            renderPagination(currentPage);

            // scroll top table wrapper si présent
            const wrapper = container.querySelector('.table-wrapper');
            if (wrapper) wrapper.scrollTop = 0;
          }

          // pagination buttons
          function renderPagination(current) {
            paginationWrap.innerHTML = '';

            function makeBtn(n) {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.dataset.page = String(n);
              btn.textContent = String(n);
              if (n === current) btn.classList.add('active');
              btn.addEventListener('click', () => gotoPage(n));
              btn.addEventListener('keydown', e => {
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); gotoPage(n); }
              });
              paginationWrap.appendChild(btn);
            }

            function makeEllipsis() {
              const ell = document.createElement('p');
              ell.textContent = '...';
              paginationWrap.appendChild(ell);
            }

            // recalculer mainRows/totalPages
            mainRows = getMainRows();
            totalItems = mainRows.length;
            totalPages = Math.max(1, Math.ceil(totalItems / rowsPerPage));

            if (totalPages <= 9) {
              for (let i = 1; i <= totalPages; i++) makeBtn(i);
            } else {
              if (current <= 5) {
                for (let i = 1; i <= 7; i++) makeBtn(i);
                makeEllipsis();
                makeBtn(totalPages);
              } else if (current >= totalPages - 4) {
                makeBtn(1);
                makeEllipsis();
                for (let i = totalPages - 6; i <= totalPages; i++) makeBtn(i);
              } else {
                makeBtn(1);
                makeEllipsis();
                for (let i = current - 2; i <= current + 2; i++) makeBtn(i);
                makeEllipsis();
                makeBtn(totalPages);
              }
            }
          }

          function gotoPage(n) {
            const pageNum = Math.min(Math.max(1, parseInt(n, 10) || 1), totalPages);
            showPage(pageNum);
          }

          // init : calcules et affichage initial
          updatePerRowCounts();
          countB.textContent = String(computeTotalPlaques());
          gotoPage(1);

          // observer pour mises à jour automatiques (sub rows ajoutées/supprimées)
          const observer = new MutationObserver(() => {
            if (paginationDebounce) clearTimeout(paginationDebounce);
            paginationDebounce = setTimeout(() => {
              // recalcul per-row + global
              updatePerRowCounts();
              countB.textContent = String(computeTotalPlaques());

              // si nombre de mainRows a changé, on réinitialise pagination
              const newMainRows = getMainRows();
              if (newMainRows.length !== mainRows.length) {
                mainRows = newMainRows;
                totalItems = mainRows.length;
                totalPages = Math.max(1, Math.ceil(totalItems / rowsPerPage));
                if (currentPage > totalPages) currentPage = totalPages;
                gotoPage(currentPage);
              } else {
                // sinon simplement refresh des boutons
                renderPagination(currentPage);
              }
            }, 120);
          });

          observer.observe(table, { childList: true, subtree: true, attributes: false });
        });
      })();


      /* ============================================================
         4) Onglets, sidebar, splash (inchangés mais centralisés)
         ============================================================ */
      (function () {
        const onglets = document.querySelectorAll('.all-onglets-container .btns-onglets .onglet');
        const containers = document.querySelectorAll('.all-onglets-container .onglet-container');

        onglets.forEach((tab, i) => {
          if (!tab.hasAttribute('tabindex')) tab.setAttribute('tabindex', '0');
          if (!tab.hasAttribute('role')) tab.setAttribute('role', 'button');

          tab.addEventListener('click', () => activate(i));
          tab.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); activate(i); }
          });
        });

        function activate(index) {
          onglets.forEach((t, i) => t.classList.toggle('active', i === index));
          containers.forEach((c, i) => c.style.display = (i === index) ? 'flex' : 'none');
        }

        const current = Array.from(onglets).findIndex(t => t.classList.contains('active'));
        activate(current === -1 ? 0 : current);
      })();

    });
  </script>
  <!-- Notification script -->
  <script>
    (() => {
      // Récupère un token CSRF si le backend le fournis (meta tag ou cookie "XSRF-TOKEN")
      function getCsrfToken() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        if (meta) return meta.getAttribute('content') || null;
        const name = 'XSRF-TOKEN=';
        const cookie = document.cookie.split('; ').find(c => c.startsWith(name));
        if (cookie) return decodeURIComponent(cookie.substring(name.length));
        return null;
      }

      // sanitize simple pour affichage (retire contrôles non imprimables et <, > pour réduire risque d'injection)
      function safeText(v) {
        if (v === null || v === undefined) return '';
        return String(v).replace(/[\u0000-\u001F\u007F<>]/g, '').trim();
      }

      // wrapper fetch qui ajoute CSRF header s'il existe
      async function fetchWithCsrf(url, opts = {}) {
        opts.credentials = 'include';
        opts.headers = opts.headers || {};
        const token = getCsrfToken();
        if (token) opts.headers['X-CSRF-Token'] = token;
        // Accept default json in many endpoints
        opts.headers['Accept'] = opts.headers['Accept'] || 'application/json';
        return fetch(url, opts);
      }

      document.addEventListener('DOMContentLoaded', () => {
        /* ------------------ Overlay & boutons d'action ------------------ */
        const ROOT_SELECTOR = '.index-start .index-elements';
        const AREA = document.querySelector(ROOT_SELECTOR);
        if (AREA) {
          const buttons = Array.from(AREA.querySelectorAll('button'));
          if (buttons.length) {
            const ANIM_DURATION = 650;
            const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            let overlay = null;
            function ensureOverlay() {
              if (overlay) return overlay;
              overlay = document.createElement('div');
              overlay.className = 'plaques-bg-overlay';
              // apparence neutre sécurisée par défaut
              overlay.style.position = 'fixed';
              overlay.style.inset = '0';
              overlay.style.zIndex = '9998';
              overlay.style.pointerEvents = 'auto';
              overlay.style.transition = 'opacity 0.25s ease';
              overlay.style.backgroundColor = 'rgba(0,0,0,0.85)';
              document.body.appendChild(overlay);
              return overlay;
            }

            function pickBackgroundFromElement(el) {
              try {
                const cs = getComputedStyle(el);
                const bgImage = cs.backgroundImage;
                if (bgImage && bgImage !== 'none' && bgImage.indexOf('gradient') !== -1) return { css: bgImage };
                const bgColor = cs.backgroundColor;
                if (bgColor && bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') return { css: bgColor };
                const inline = el.style.background || el.style.backgroundImage || el.style.backgroundColor;
                if (inline) return { css: inline };
              } catch (e) {
                // ignore and fallback
              }
              return null;
            }

            const hrefMap = {
              'plaques': 'Plaque/plaques.html',
              'suivi des plaques': 'Plaque/suiviplaque.html',
              'clients': 'Client/clients.html',
              'produits': 'Produit/produits.html',
              'conceptions': 'Conception/conceptions.html',
              'parametres': 'Parametres/parametres.html',
              'annonces': 'Annonces/annonces.html',
              'scan qr': 'Scan/scan.html',
              'tableau de bord': 'index.html',
              'dashboard': 'index.html',
              'accueil': 'index.html'
            };

            function guessHrefFromText(text) {
              if (!text) return null;
              const t = text.toLowerCase().replace(/\s+/g, ' ').trim();

              // match exact map or substring (existing)
              if (hrefMap[t]) return hrefMap[t];
              for (const key in hrefMap) if (t.includes(key)) return hrefMap[key];

              // token-based fallback: si le label contient à la fois "scan" et "qr"
              const words = t.split(/\s+/);
              if (words.includes('scan') && words.includes('qr')) return hrefMap['scan qr'];

              // autres cas : si contient 'scan' et 'plaque' -> aussi rediriger vers scan
              if (words.includes('scan') && words.includes('plaque')) return hrefMap['scan qr'];

              return null;
            }


            function getTargetHref(btn) {
              const dh = btn.getAttribute('data-href') || btn.getAttribute('data-url') || btn.dataset.href || btn.dataset.url;
              if (dh) return dh;
              const a = btn.querySelector('a[href]');
              if (a) return a.getAttribute('href');
              const text = (btn.textContent || '').trim();
              const guess = guessHrefFromText(text);
              if (guess) return guess;
              return null;
            }

            function showOverlayThenRedirect(btn, href) {
              if (!href) return;
              if (reduceMotion) {
                // navigation directe, same-origin assumed
                window.location.assign(href);
                return;
              }

              const bg = pickBackgroundFromElement(btn) || { css: 'rgba(0,0,0,0.85)' };
              const ov = ensureOverlay();

              try {
                if (bg.css && bg.css.indexOf && bg.css.indexOf('gradient') !== -1) {
                  ov.style.backgroundImage = bg.css;
                  ov.style.backgroundColor = '';
                } else if (bg.css) {
                  ov.style.backgroundImage = 'none';
                  ov.style.backgroundColor = bg.css;
                } else {
                  ov.style.backgroundImage = 'none';
                  ov.style.backgroundColor = 'rgba(0,0,0,0.85)';
                }
              } catch (e) {
                ov.style.backgroundImage = 'none';
                ov.style.backgroundColor = 'rgba(0,0,0,0.85)';
              }

              // bloque interactions
              buttons.forEach(b => b.disabled = true);
              // forcer reflow + afficher
              void ov.offsetWidth;
              ov.classList.add('show');

              setTimeout(() => {
                // redirection (relative URL)
                window.location.assign(href);
              }, ANIM_DURATION);
            }

            // attache handlers
            buttons.forEach(btn => {
              btn.addEventListener('click', (e) => {
                if (btn.hasAttribute('data-no-transition')) return;
                const href = getTargetHref(btn);
                if (!href) return; // laisse comportement par défaut si aucun href trouvé
                e.preventDefault();
                showOverlayThenRedirect(btn, href);
              });
            });

            // ESC pour retirer overlay si présent
            document.addEventListener('keydown', (e) => {
              if (e.key === 'Escape' && overlay && overlay.classList.contains('show')) {
                overlay.classList.remove('show');
                buttons.forEach(b => b.disabled = false);
                setTimeout(() => {
                  if (overlay) { overlay.remove(); overlay = null; }
                }, Math.max(ANIM_DURATION, 200));
              }
            });
          }
        }

        /* ------------------ Sidebar / notifications (UNIFIÉ overlay via classe .visible) ------------------ */
        const burgerBtn = document.querySelector('.header .burger');
        const closeBtn = document.querySelector('.sidebar .close-sidebar');
        const sidebar = document.querySelector('.sidebar');
        const notifBtn = document.querySelector('.notif-user');
        const sidenotifEl = document.querySelector('.sidenotif');
        const filterOverlay = document.querySelector('.filterblack');

        if (!filterOverlay) throw new Error('filterOverlay non trouvé');

        filterOverlay.style.transition = 'opacity 0.3s ease'; // laisse le CSS gérer display/opacité via la classe

        // assure état initial cohérent (on laisse le CSS gérer display via .visible)
        filterOverlay.classList.remove('visible');
        if (sidebar) { sidebar.style.transform = 'translateX(-100%)'; sidebar.style.transition = 'transform 0.3s ease'; }
        if (sidenotifEl) { sidenotifEl.style.transform = 'translateX(100%)'; sidenotifEl.style.transition = 'transform 0.3s ease'; sidenotifEl.addEventListener('click', e => e.stopPropagation()); }

        let sidebarOpen = false, notifOpen = false;

        function showOverlay() {
          filterOverlay.classList.add('visible'); // CSS .filterblack.visible { display:block; opacity:0.8; }
          // ensure it's visible for screen readers/interaction if needed
          filterOverlay.setAttribute('aria-hidden', 'false');
        }
        function hideOverlayIfNeeded() {
          if (!sidebarOpen && !notifOpen) {
            filterOverlay.classList.remove('visible');
            filterOverlay.setAttribute('aria-hidden', 'true');
          }
        }

        // open/close qui gardent la logique existante + overlay via classe
        function openSidebar() {
          if (!sidebar) return;
          sidebar.style.transform = 'translateX(0)';
          sidebarOpen = true;
          showOverlay();
        }
        function closeSidebar() {
          if (!sidebar) return;
          sidebar.style.transform = 'translateX(-100%)';
          sidebarOpen = false;
          hideOverlayIfNeeded();
        }
        function openNotif() {
          if (!sidenotifEl) return;
          sidenotifEl.style.transform = 'translateX(0)';
          notifOpen = true;
          showOverlay();
        }
        function closeNotif() {
          if (!sidenotifEl) return;
          sidenotifEl.style.transform = 'translateX(100%)';
          notifOpen = false;
          hideOverlayIfNeeded();
        }

        // handlers
        if (burgerBtn) burgerBtn.addEventListener('click', (e) => { e.stopPropagation(); openSidebar(); });
        if (closeBtn) closeBtn.addEventListener('click', (e) => { e.stopPropagation(); closeSidebar(); });
        if (filterOverlay) filterOverlay.addEventListener('click', () => { if (sidebarOpen) closeSidebar(); if (notifOpen) closeNotif(); });
        if (notifBtn) notifBtn.addEventListener('click', (e) => { e.stopPropagation(); notifOpen ? closeNotif() : openNotif(); });

        // accessibility: fermer avec Escape
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            if (sidebarOpen) closeSidebar();
            if (notifOpen) closeNotif();
          }
        });

        /* ------------------ Vérification d'authentification & déconnexion ------------------ */
        (async function checkAuthAndBindLogout() {
          try {
            const res = await fetch('/auth/me', {
              method: 'GET',
              credentials: 'include' // Important pour les cookies
            });

            if (!res.ok) {
              window.location.replace('login.html');
              return;
            }

            const userData = await res.json();
            console.log('Utilisateur connecté:', userData);

            // Gestion de la déconnexion
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
              logoutBtn.addEventListener('click', async () => {
                await fetch('/auth/logout', {
                  method: 'POST',
                  credentials: 'include'
                });
                window.location.replace('login.html');
              });
            }
          } catch (err) {
            console.error('Erreur de vérification auth:', err);
            window.location.replace('login.html');
          }
        })();

      }); // DOMContentLoaded
    })();

    document.addEventListener('DOMContentLoaded', function () {
      const notifContainer = document.querySelector('.sidenotif .notif-elements');
      const notifCountEl = document.querySelector('.notif-count');
      const notifBtn = document.querySelector('.notif-user');
      const sidenotifEl = document.querySelector('.sidenotif');
      const API_BASE = ''; // même origine
      const POLL_INTERVAL = 15000; // 15s

      function getCsrfToken() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        if (meta) return meta.getAttribute('content');
        const cookie = document.cookie.split('; ').find(c => c.trim().startsWith('XSRF-TOKEN='));
        if (cookie) return decodeURIComponent(cookie.split('=')[1]);
        return '';
      }

      async function getUserInfo() {
        // if DOM has prefilled data-user-id/role, use it
        try {
          if (sidenotifEl && sidenotifEl.dataset && (sidenotifEl.dataset.userId || sidenotifEl.dataset.role)) {
            return { id: sidenotifEl.dataset.userId || null, role: sidenotifEl.dataset.role || null };
          }
          const r = await fetch('/auth/me', { method: 'GET', credentials: 'include' });
          if (!r.ok) {
            console.warn('/auth/me not OK', r.status);
            return { id: null, role: null };
          }
          const data = await r.json();
          // normalise possible keys
          const id = data.id || data.user_id || data.id_utilisateur || null;
          const role = data.role || (data.employe && data.employe.role) || null;
          console.log('getUserInfo ->', { id, role, raw: data });
          return { id, role };
        } catch (e) {
          console.error('getUserInfo error', e);
          return { id: null, role: null };
        }
      }

      async function fetchNotificationsFor(user) {
        if (!user) user = await getUserInfo();
        if (!user) user = { id: null, role: null };
        const params = [];
        if (user.id) params.push('user_id=' + encodeURIComponent(user.id));
        if (user.role) params.push('role=' + encodeURIComponent(user.role));
        const qs = params.length ? ('?' + params.join('&')) : '';
        const url = `${API_BASE}/notifications${qs}&limit=500`.replace('?&', '?');
        console.log('fetchNotifications url:', url);
        try {
          const res = await fetch(url, { method: 'GET', credentials: 'include', headers: { 'Accept': 'application/json' } });
          if (!res.ok) {
            console.warn('fetchNotifications non OK', res.status);
            const txt = await res.text();
            console.warn('fetch body:', txt);
            return [];
          }
          const data = await res.json();
          const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
          console.log('fetchNotifications result count', items.length);
          return items;
        } catch (e) {
          console.error('Erreur fetchNotifications', e);
          return [];
        }
      }

      function formatNotificationDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const now = new Date();
        const days = Math.floor((now - date) / (1000 * 60 * 60 * 24));
        if (days === 0) return "Aujourd'hui";
        if (days === 1) return "Hier";
        if (days < 7) return `Il y a ${days} jours`;
        return date.toLocaleDateString('fr-FR');
      }

      function createNotificationHTML(notification) {
        const isRead = !!(notification.lue || notification.read);
        let iconSrc = '../img/icon/info.png';
        const type = notification.type_notif || notification.type;
        if (type === 'ajout_plaque') iconSrc = '../img/icon/info.png';
        if (type === 'renouvellement_plaque') iconSrc = '../img/icon/info.png';

        const id = notification.id_notification || notification.id || '';
        const msg = (notification.message || notification.text || notification.title || 'Nouvelle notification')
          .replace(/</g, '&lt;').replace(/>/g, '&gt;');

        return `
      <div class="notif-card ${isRead ? 'notif-read' : 'notif-unread'}" data-id="${id}"
           data-target-conception="${notification.id_conception || ''}"
           data-type="${type}">
        <div class="notif-card-icon"><img src="${iconSrc}" alt="icon"></div>
        <div class="notif-card-text">
          <p>${msg}</p>
          <small>${formatNotificationDate(notification.date_creation || notification.created_at)}</small>
        </div>
      </div>
    `;
      }

      function renderNotifications(notifications) {
        if (!notifContainer) return;
        if (!notifications || notifications.length === 0) {
          notifContainer.innerHTML = `<div class="notif-empty"><p>Aucune notification</p></div>`;
          if (notifCountEl) { notifCountEl.textContent = '0'; notifCountEl.style.display = 'none'; }
          return;
        }
        const byDate = {};
        (notifications || []).forEach(n => {
          const key = formatNotificationDate(n.date_creation || n.created_at || n.date) || 'Autre';
          (byDate[key] = byDate[key] || []).push(n);
        });
        let html = '';
        Object.keys(byDate).forEach(date => {
          html += `<div class="notif-day"><h3>${date}</h3></div>`;
          byDate[date].forEach(n => html += createNotificationHTML(n));
        });
        notifContainer.innerHTML = html;

        const unread = notifications.filter(n => !(n.lue || n.read)).length;
        if (notifCountEl) {
          notifCountEl.textContent = String(unread);
          notifCountEl.style.display = unread > 0 ? 'inline-block' : 'none';
        }
      }

      async function markAsReadLocal(notificationId, user) {
        if (!notificationId) return false;
        user = user || await getUserInfo();
        const params = [];
        if (user.id) params.push('user_id=' + encodeURIComponent(user.id));
        if (user.role) params.push('role=' + encodeURIComponent(user.role));
        const qs = params.length ? ('?' + params.join('&')) : '';
        const url = `${API_BASE}/notifications/mark_read${qs}`;
        console.log('markAsReadLocal ->', url, 'payload', notificationId);
        try {
          const res = await fetch(url, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrfToken() || '' },
            body: JSON.stringify({ id_notification: notificationId })
          });
          if (!res.ok) {
            console.warn('mark_read failed', res.status, await res.text());
            return false;
          }
          console.log('mark_read ok', await res.json());
          return true;
        } catch (e) {
          console.error('markAsReadLocal error', e);
          return false;
        }
      }

      async function markAllRead(user) {
        user = user || await getUserInfo();
        if (!user) { console.warn('markAllRead: no user'); return false; }
        const params = [];
        if (user.id) params.push('user_id=' + encodeURIComponent(user.id));
        if (user.role) params.push('role=' + encodeURIComponent(user.role));
        if (!params.length) { console.warn('markAllRead: no user_id or role'); return false; }
        const url = `${API_BASE}/notifications/mark_all_read?${params.join('&')}`;
        console.log('markAllRead ->', url);
        try {
          const res = await fetch(url, { method: 'POST', credentials: 'include', headers: { 'X-CSRF-Token': getCsrfToken() || '' } });
          if (!res.ok) {
            console.warn('markAllRead non OK', res.status);
            console.warn('body', await res.text());
            return false;
          }
          console.log('markAllRead ok', await res.json());
          return true;
        } catch (e) {
          console.error('Erreur markAllRead', e);
          return false;
        }
      }

      // Delegation click on card
      if (notifContainer) {
        notifContainer.addEventListener('click', async function (e) {
          const card = e.target.closest('.notif-card');
          if (!card) return;
          const id = card.dataset.id;
          // optimistic UI
          card.classList.add('notif-read');
          card.classList.remove('notif-unread');
          if (notifCountEl) {
            const current = parseInt(notifCountEl.textContent || '0', 10);
            const newVal = Math.max(0, current - 1);
            notifCountEl.textContent = String(newVal);
            notifCountEl.style.display = newVal > 0 ? 'inline-block' : 'none';
          }
          const user = await getUserInfo();
          await markAsReadLocal(id, user);
          const idConception = card.dataset.targetConception;
          if (idConception) {
            window.location.href = `/Conception/conception.html?id=${encodeURIComponent(idConception)}`;
            return;
          }
          window.dispatchEvent(new Event('closeNotificationsPanel'));
        });
      }

      if (notifBtn) {
        notifBtn.addEventListener('click', async function (e) {
          const user = await getUserInfo();
          const ok = await markAllRead(user);
          if (ok) {
            document.querySelectorAll('.sidenotif .notif-card').forEach(c => { c.classList.add('notif-read'); c.classList.remove('notif-unread'); });
            if (notifCountEl) { notifCountEl.textContent = '0'; notifCountEl.style.display = 'none'; }
          }
          // reload to catch server state
          setTimeout(loadNotifications, 300);
        });
      }

      async function loadNotifications() {
        const user = await getUserInfo();
        console.log('loadNotifications for', user);
        const arr = await fetchNotificationsFor(user);
        renderNotifications(arr);
      }

      // initial + polling
      loadNotifications();
      setInterval(loadNotifications, POLL_INTERVAL);

      // Expose for debug in console
      window.__notif_debug = {
        loadNotifications,
        fetchNotificationsFor,
        markAllRead,
        markAsReadLocal,
        getUserInfo
      };
      console.log('notification debug helper available at window.__notif_debug');
    });
  </script>

  <script src="plaques.js?v=2"></script>
  <script src="plaque_quarentaine.js"></script>
</body>

</html>